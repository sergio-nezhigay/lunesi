class GiftBundleManager {
  constructor() {
    this.variantId = '43668412792963';
    this.cookieName = 'beyours:gift-bundle-claimed';
    this.isInitialized = false;
    this.init();
  }

  init() {
    if (this.isInitialized) return;
    this.isInitialized = true;

    this.bindEvents();
    this.checkForEmailCoupon();
    this.updateGiftButtonStates();
    this.validateCart();
    this.updateGiftSection();
    
    // –°–ª—É—Ö–∞—Ç–∏ –∑–º—ñ–Ω–∏ –≤ –∫–æ—à–∏–∫—É
    document.addEventListener('cart:updated', () => {
      this.updateGiftButtonStates();
      this.validateCart();
      this.updateGiftSection();
    });
    
    // –î–æ–¥–∞—Ç–∏ —Å–ª—É—Ö–∞—á –¥–ª—è –∫–ª—ñ–∫—ñ–≤
    document.addEventListener('click', () => {
      setTimeout(() => {
        this.validateCart();
        this.updateGiftButtonStates();
      }, 100);
    });

    // –ü–µ—Ä–µ–≤—ñ—Ä—è—Ç–∏ –≤–∞–ª—ñ–¥–∞—Ü—ñ—é –∫–æ–∂–Ω—ñ 2 —Å–µ–∫—É–Ω–¥–∏
    setInterval(() => {
      this.validateCart();
      this.updateGiftSection();
    }, 2000);

    // –¢–µ—Å—Ç—É–≤–∞–Ω–Ω—è –ª–æ–≥—ñ–∫–∏ - –¥–æ–¥–∞—Ç–∏ –∫–æ–º–∞–Ω–¥–∏ –¥–ª—è –∫–æ–Ω—Å–æ–ª—ñ
    window.testGiftLogic = () => {
      console.log('üéÅ === GIFT LOGIC TEST ===');
      console.log('üéÅ Email submitted:', sessionStorage.getItem('gift-email-submitted'));
      console.log('üéÅ Gift claimed:', this.isGiftClaimed());
      console.log('üéÅ Gift in cart:', this.isGiftInCart());
      console.log('üéÅ Non-gift items count:', this.getNonGiftItemsCount());
      console.log('üéÅ Gift section element:', document.getElementById('gift-section'));
      console.log('üéÅ Checkout buttons:', document.querySelectorAll('button[name="checkout"], button[data-checkout-button]'));
      console.log('üéÅ === END TEST ===');
    };
  }

  bindEvents() {
    // –î–æ–¥–∞—Ç–∏ –æ–±—Ä–æ–±–Ω–∏–∫–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ –¥–æ–¥–∞–≤–∞–Ω–Ω—è –≥—ñ—Ñ—Ç–∞
    document.addEventListener('click', (e) => {
      // –ó–Ω–∞–π—Ç–∏ –Ω–∞–π–±–ª–∏–∂—á–∏–π –µ–ª–µ–º–µ–Ω—Ç –∑ –ø–æ—Ç—Ä—ñ–±–Ω–∏–º –∞—Ç—Ä–∏–±—É—Ç–æ–º
      const addButton = e.target.closest('[data-gift-bundle-add]');
      const removeButton = e.target.closest('[data-gift-bundle-remove]');
      const triggerButton = e.target.closest('[data-gift-popup-trigger]');
      
      if (addButton) {
        e.preventDefault();
        this.addGiftBundle();
      }
      if (removeButton) {
        e.preventDefault();
        this.removeGiftBundle();
      }
      if (triggerButton) {
        e.preventDefault();
        this.openGiftPopup();
      }
    });
  }

  // –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ —á–∏ –ø—Ä–∏–π—à–ª–∏ –∑ email –∑ –∫—É–ø–æ–Ω–æ–º
  checkForEmailCoupon() {
    const urlParams = new URLSearchParams(window.location.search);
    const discount = urlParams.get('discount') || urlParams.get('coupon') || urlParams.get('code');
    
    // –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ URL –Ω–∞ –Ω–∞—è–≤–Ω—ñ—Å—Ç—å discount –∫–æ–¥—É
    const currentPath = window.location.pathname;
    const pathMatch = currentPath.match(/\/discount\/([^\/\?]+)/);
    const pathDiscount = pathMatch ? pathMatch[1] : null;
    
    const foundCode = discount || pathDiscount;
    
    // –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ —á–∏ –≤–∂–µ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ñ –ø—Ä–∞–ø–æ—Ä—Ü—ñ –∑ gift-simple.js
    const couponUsed = sessionStorage.getItem('gift-coupon-used') === 'true' ||
                      localStorage.getItem('gift-coupon-used') === 'true';
    
    if ((foundCode && foundCode.toLowerCase() === 'freebundle') || couponUsed) {
      
      // –í—Å—Ç–∞–Ω–æ–≤–∏—Ç–∏ –≤—Å—ñ –Ω–µ–æ–±—Ö—ñ–¥–Ω—ñ –ø—Ä–∞–ø–æ—Ä—Ü—ñ (—Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—è –∑ gift-simple.js)
      sessionStorage.setItem('gift-email-submitted', 'true');
      sessionStorage.setItem('gift-coupon-used', 'true');
      sessionStorage.setItem('gift-popup-closed', 'true');
      
      this.addGiftBundle();
      this.markGiftAsClaimed();
      
      // –û—á–∏—Å—Ç–∏—Ç–∏ URL –≤—ñ–¥ –ø–∞—Ä–∞–º–µ—Ç—Ä—ñ–≤ —Ç—ñ–ª—å–∫–∏ —è–∫—â–æ —Ü–µ –±—É–≤ URL –ø–∞—Ä–∞–º–µ—Ç—Ä
      if (discount && !pathDiscount) {
        const cleanUrl = window.location.pathname;
        window.history.replaceState({}, document.title, cleanUrl);
      }
    }
  }

  async addGiftBundle() {
    if (this.isGiftInCart()) return;
    if (this.isGiftClaimed()) return;

    try {
      const response = await fetch('/cart/add.js', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          id: this.variantId,
          quantity: 1,
          properties: {
            '_gift_bundle': 'true',
            '_gift_source': 'email_or_popup'
          }
        }),
      });

      if (response.ok) {
        const result = await response.json();
        this.markGiftAsClaimed();
        
        // –î–æ–¥–∞—Ç–∏ –¥–æ–¥–∞—Ç–∫–æ–≤–∏–π cookie –¥–ª—è –≤—ñ–¥—Å—Ç–µ–∂–µ–Ω–Ω—è –ø—Ä–∞–≤–∞ –Ω–∞ –ø–æ–¥–∞—Ä—É–Ω–æ–∫
        document.cookie = 'beyours:gift-bundle-claimed=true; max-age=' + (30 * 24 * 60 * 60) + '; path=/';
        
        // –û–Ω–æ–≤–∏—Ç–∏ –≤—Å—ñ —Å–µ–∫—Ü—ñ—ó –∫–æ—à–∏–∫–∞
        this.updateCartSections();
        
        // –ü–æ–∫–∞–∑–∞—Ç–∏ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è
        this.showGiftAddedMessage();
        
        // –í—ñ–¥–∫—Ä–∏—Ç–∏ –∫–æ—à–∏–∫
        this.openMiniCart();
      }
    } catch (error) {
      console.error('–ü–æ–º–∏–ª–∫–∞ –¥–æ–¥–∞–≤–∞–Ω–Ω—è –≥—ñ—Ñ—Ç-–±–∞–Ω–¥–ª—É:', error);
    }
  }

  async removeGiftBundle() {
    const giftLineItem = this.getGiftLineItem();
    if (!giftLineItem) return;

    try {
      const response = await fetch('/cart/change.js', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          id: this.variantId,
          quantity: 0
        }),
      });

      if (response.ok) {
        this.updateCartSections();
        this.updateGiftButtonStates();
        this.validateCart();
      }
    } catch (error) {
      console.error('–ü–æ–º–∏–ª–∫–∞ –≤–∏–¥–∞–ª–µ–Ω–Ω—è –≥—ñ—Ñ—Ç-–±–∞–Ω–¥–ª—É:', error);
    }
  }

  isGiftInCart() {
    // –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ —á–µ—Ä–µ–∑ DOM –µ–ª–µ–º–µ–Ω—Ç–∏ (–¥–ª—è –æ–±–æ—Ö —Ç–∏–ø—ñ–≤ –∫–æ—à–∏–∫–∞)
    const cartItems = document.querySelectorAll('[data-variant-id]');
    const domCheck = Array.from(cartItems).some(item => 
      item.dataset.variantId === this.variantId
    );
    
    // –î–æ–¥–∞—Ç–∫–æ–≤–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞ —á–µ—Ä–µ–∑ Liquid –∑–º—ñ–Ω–Ω—ñ (—è–∫—â–æ —î)
    const liquidCheck = window.cartHasGift || false;
    
    return domCheck || liquidCheck;
  }

  getGiftLineItem() {
    return document.querySelector(`[data-variant-id="${this.variantId}"]`);
  }

  isGiftClaimed() {
    // –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ cookie
    const match = document.cookie.match(`(^|;)\\s*${this.cookieName}\\s*=\\s*([^;]+)`);
    const cookieCheck = match ? match[2] === 'true' : false;
    
    // –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ sessionStorage —Ç–∞ localStorage (–∑ gift-simple.js)
    const sessionCheck = sessionStorage.getItem('gift-email-submitted') === 'true' ||
                         sessionStorage.getItem('gift-coupon-used') === 'true';
    const localCheck = localStorage.getItem('gift-email-submitted') === 'true' ||
                      localStorage.getItem('gift-coupon-used') === 'true';
    
    return cookieCheck || sessionCheck || localCheck;
  }

  markGiftAsClaimed() {
    // –í—Å—Ç–∞–Ω–æ–≤–∏—Ç–∏ cookie –Ω–∞ 30 –¥–Ω—ñ–≤
    document.cookie = `${this.cookieName}=true; max-age=${30 * 24 * 60 * 60}; path=/`;
  }

  updateGiftButtonStates() {
    const isInCart = this.isGiftInCart();
    const addButtons = document.querySelectorAll('[data-gift-bundle-add]');
    const removeButtons = document.querySelectorAll('[data-gift-bundle-remove]');

    addButtons.forEach(button => {
      button.disabled = isInCart;
      const label = button.querySelector('.label');
      if (label) {
        label.textContent = isInCart ? 'Gift in Cart' : 'Add Gift';
      }
      button.classList.toggle('gift-added', isInCart);
    });

    removeButtons.forEach(button => {
      button.style.display = isInCart ? 'block' : 'none';
    });
  }

  validateCart() {
    const isGiftInCart = this.isGiftInCart();
    const otherItemsCount = this.getNonGiftItemsCount();
    
    console.log('üîç DEBUG validateCart:', {
      isGiftInCart,
      otherItemsCount,
      shouldBlock: isGiftInCart && otherItemsCount === 0
    });
    
    // –ó–Ω–∞–π—Ç–∏ –≤—Å—ñ –∫–Ω–æ–ø–∫–∏ —á–µ–∫–∞—É—Ç—É (–≤ drawer —ñ –Ω–∞ –∑–≤–∏—á–∞–π–Ω—ñ–π —Å—Ç–æ—Ä—ñ–Ω—Ü—ñ –∫–æ—à–∏–∫–∞)
    const checkoutButtons = document.querySelectorAll('button[name="checkout"], button[data-checkout-button], .btn[name="checkout"], input[name="checkout"]');
    const validationMessages = document.querySelectorAll('.gift-validation-message');
    
    // –î–æ–¥–∞—Ç–∫–æ–≤—ñ —Å–µ–ª–µ–∫—Ç–æ—Ä–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫
    const additionalButtons = document.querySelectorAll('.cart__checkout-button, .button[type="submit"]');
    const allButtonsNodeList = [...checkoutButtons, ...additionalButtons];
    
    // –§—ñ–ª—å—Ç—Ä—É–≤–∞—Ç–∏ –∫–Ω–æ–ø–∫–∏ - –≤–∏–∫–ª—é—á–∏—Ç–∏ newsletter —Ç–∞ —ñ–Ω—à—ñ –Ω–µ-checkout –∫–Ω–æ–ø–∫–∏
    const allButtons = allButtonsNodeList.filter(button => {
      const buttonText = button.textContent.toLowerCase().trim();
      const buttonClass = button.className.toLowerCase();
      const buttonParent = button.closest('.newsletter, .footer, [class*="newsletter"], [class*="subscribe"]');
      
      // –í–∏–∫–ª—é—á–∏—Ç–∏ newsletter –∫–Ω–æ–ø–∫–∏
      if (buttonParent || 
          buttonText.includes('newsletter') || 
          buttonText.includes('subscribe') || 
          buttonClass.includes('newsletter') ||
          buttonClass.includes('subscribe')) {
        return false;
      }
      
      return true;
    });
    
    console.log('üîç All checkout buttons found:', allButtons.length, allButtons);
    
    console.log('üîç DEBUG elements found:', {
      checkoutButtons: checkoutButtons.length,
      validationMessages: validationMessages.length
    });


    if (isGiftInCart && otherItemsCount === 0) {
      console.log('üö´ BLOCKING checkout - gift only in cart');
      
      // –ì—ñ—Ñ—Ç —î, –∞–ª–µ –Ω–µ–º–∞—î —ñ–Ω—à–∏—Ö —Ç–æ–≤–∞—Ä—ñ–≤ - –±–ª–æ–∫—É–≤–∞—Ç–∏ —á–µ–∫–∞—É—Ç
      allButtons.forEach((checkoutButton, index) => {
        if (checkoutButton) {
          console.log(`üö´ Disabling button ${index}:`, checkoutButton);
          checkoutButton.disabled = true;
          checkoutButton.classList.add('button--disabled');
          checkoutButton.setAttribute('disabled', 'disabled');
          
          // –û–Ω–æ–≤–∏—Ç–∏ —Ç–µ–∫—Å—Ç –∫–Ω–æ–ø–∫–∏
          const originalText = checkoutButton.textContent.trim();
          if (originalText.includes('Checkout') || originalText === 'Checkout') {
            checkoutButton.textContent = 'Add Item to Checkout';
          }
        }
      });
      
      // –ü–æ–∫–∞–∑–∞—Ç–∏ –∞–±–æ —Å—Ç–≤–æ—Ä–∏—Ç–∏ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –≤–∞–ª—ñ–¥–∞—Ü—ñ—ó
      console.log('üìù Handling validation messages, found:', validationMessages.length);
      if (validationMessages.length === 0) {
        console.log('üìù Creating new validation messages');
        this.createValidationMessages();
      } else {
        console.log('üìù Showing existing validation messages');
        validationMessages.forEach((validationMessage, index) => {
          if (validationMessage) {
            console.log(`üìù Showing message ${index}:`, validationMessage);
            validationMessage.style.display = 'block';
          }
        });
      }
    } else {
      console.log('‚úÖ ALLOWING checkout - valid cart');
      
      // –í–∞–ª—ñ–¥–Ω–∏–π –∫–æ—à–∏–∫ - –¥–æ–∑–≤–æ–ª–∏—Ç–∏ —á–µ–∫–∞—É—Ç
      allButtons.forEach((checkoutButton, index) => {
        if (checkoutButton) {
          console.log(`‚úÖ Enabling button ${index}:`, checkoutButton);
          checkoutButton.disabled = false;
          checkoutButton.classList.remove('button--disabled');
          checkoutButton.removeAttribute('disabled');
          
          // –í—ñ–¥–Ω–æ–≤–∏—Ç–∏ —Ç–µ–∫—Å—Ç –∫–Ω–æ–ø–∫–∏
          if (checkoutButton.textContent.includes('Add Item')) {
            checkoutButton.textContent = 'Checkout';
          }
        }
      });
      
      // –ü—Ä–∏—Ö–æ–≤–∞—Ç–∏ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –≤–∞–ª—ñ–¥–∞—Ü—ñ—ó
      console.log('üôà Hiding validation messages');
      validationMessages.forEach((validationMessage, index) => {
        if (validationMessage) {
          console.log(`üôà Hiding message ${index}:`, validationMessage);
          validationMessage.style.display = 'none';
        }
      });
    }
  }

  getNonGiftItemsCount() {
    // –°–ø–æ—á–∞—Ç–∫—É –ø–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ —á–∏ —î –¥–∞–Ω—ñ –∑ Liquid
    if (typeof window.cartNonGiftItemsCount !== 'undefined') {
      return window.cartNonGiftItemsCount;
    }
    
    const cartItems = document.querySelectorAll('[data-variant-id]');
    let count = 0;
    
    // –°–ø—Ä–æ–±—É–≤–∞—Ç–∏ —Ä–∞—Ö—É–≤–∞—Ç–∏ —á–µ—Ä–µ–∑ DOM –µ–ª–µ–º–µ–Ω—Ç–∏
    if (cartItems.length > 0) {
      cartItems.forEach(item => {
        if (item.dataset.variantId !== this.variantId) {
          // –î–ª—è –∑–≤–∏—á–∞–π–Ω–æ–≥–æ –∫–æ—à–∏–∫–∞ —Ä–∞—Ö—É–≤–∞—Ç–∏ –∫—ñ–ª—å–∫—ñ—Å—Ç—å –∑ input
          const quantityInput = item.querySelector('input[name="updates[]"]');
          if (quantityInput) {
            count += parseInt(quantityInput.value) || 0;
          } else {
            count += 1; // –î–ª—è mini-cart –¥–µ –Ω–µ–º–∞—î input
          }
        }
      });
    }
    
    return count;
  }

  async getCartItemsFromAPI() {
    try {
      const response = await fetch('/cart.js');
      const cart = await response.json();
      return cart.items || [];
    } catch (error) {
      console.error('Error fetching cart:', error);
      return [];
    }
  }

  createValidationMessages() {
    console.log('üî® createValidationMessages called');
    
    // –°–ø—Ä–æ–±—É–≤–∞—Ç–∏ —Ä—ñ–∑–Ω—ñ —Å–µ–ª–µ–∫—Ç–æ—Ä–∏ –¥–ª—è mini-cart
    const miniCartSelectors = [
      '.mini-cart__footer',
      '.drawer__footer', 
      '.cart-drawer__footer',
      '.mini-cart .footer',
      '[class*="mini-cart"] [class*="footer"]'
    ];
    
    let miniCartFooter = null;
    for (const selector of miniCartSelectors) {
      miniCartFooter = document.querySelector(selector);
      if (miniCartFooter) {
        console.log('üî® Mini cart footer found with selector:', selector);
        break;
      }
    }
    
    if (miniCartFooter) {
      const existingMsg = miniCartFooter.querySelector('.gift-validation-message');
      console.log('üî® Existing mini cart message:', !!existingMsg);
      
      if (!existingMsg) {
        console.log('üî® Creating mini cart validation message');
        const validationSection = document.createElement('div');
        validationSection.className = 'mini-cart__validation-section';
        validationSection.style.cssText = 'margin: 16px 0; padding: 0 20px;';
        validationSection.innerHTML = `
          <div class="gift-validation-message" style="background: #f8f9fa; border: 1px solid #e9ecef; border-radius: 4px; padding: 12px 16px;">
            <div class="validation-content" style="display: flex; align-items: center; justify-content: center;">
              <div class="validation-text">
                <p style="margin: 0; font-size: 12px; color: #6c757d; text-align: center;">Add one more item to cart to proceed with checkout</p>
              </div>
            </div>
          </div>
        `;
        
        // –°–ø—Ä–æ–±—É–≤–∞—Ç–∏ –¥–æ–¥–∞—Ç–∏ –≤ —Ä—ñ–∑–Ω—ñ –º—ñ—Å—Ü—è
        const firstCheckoutButton = miniCartFooter.querySelector('button[name="checkout"], button[data-checkout-button], .button[type="submit"]');
        if (firstCheckoutButton) {
          firstCheckoutButton.parentNode.insertBefore(validationSection, firstCheckoutButton);
          console.log('üî® Mini cart validation message inserted before checkout button');
        } else {
          miniCartFooter.appendChild(validationSection);
          console.log('üî® Mini cart validation message appended to footer');
        }
      }
    } else {
      console.log('üî® Mini cart footer not found, trying alternative approach');
      // –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–∏–π –ø—ñ–¥—Ö—ñ–¥ - –∑–Ω–∞–π—Ç–∏ checkout –∫–Ω–æ–ø–∫—É —ñ –¥–æ–¥–∞—Ç–∏ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –ø–µ—Ä–µ–¥ –Ω–µ—é
      const miniCartButtons = document.querySelectorAll('button[name="checkout"], button[data-checkout-button]');
      miniCartButtons.forEach((button, index) => {
        const buttonParent = button.closest('.mini-cart, .drawer, .cart-drawer, [class*="mini-cart"]');
        if (buttonParent && !buttonParent.querySelector('.gift-validation-message')) {
          console.log(`üî® Creating validation message for mini-cart button ${index}`);
          const validationDiv = document.createElement('div');
          validationDiv.className = 'gift-validation-message';
          validationDiv.style.cssText = 'background: #f8f9fa; border: 1px solid #e9ecef; border-radius: 4px; padding: 12px 16px; margin: 16px 0;';
          validationDiv.innerHTML = `
            <div class="validation-content" style="display: flex; align-items: center; justify-content: center;">
              <div class="validation-text">
                <p style="margin: 0; font-size: 12px; color: #6c757d; text-align: center;">Add one more item to cart to proceed with checkout</p>
              </div>
            </div>
          `;
          button.parentNode.insertBefore(validationDiv, button);
        }
      });
    }
    
    // –°—Ç–≤–æ—Ä–∏—Ç–∏ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –¥–ª—è –∑–≤–∏—á–∞–π–Ω–æ–≥–æ cart
    const cartFooter = document.querySelector('.cart__footer');
    if (cartFooter) {
      const existingMsg = cartFooter.querySelector('.gift-validation-message');
      if (!existingMsg) {
        const validationSection = document.createElement('div');
        validationSection.className = 'cart__validation-section';
        validationSection.style.cssText = 'margin: 20px 0;';
        validationSection.innerHTML = `
          <div class="gift-validation-message" style="background: #f8f9fa; border: 1px solid #e9ecef; border-radius: 4px; padding: 12px 16px;">
            <div class="validation-content" style="display: flex; align-items: center; justify-content: center;">
              <div class="validation-text">
                <p style="margin: 0; font-size: 14px; color: #6c757d; text-align: center;">Add one more item to cart to proceed with checkout</p>
              </div>
            </div>
          </div>
        `;
        cartFooter.appendChild(validationSection);
      }
    }
  }

  async updateCartSections() {
    try {
      const response = await fetch(`/cart?section_id=mini-cart`);
      const text = await response.text();
      const parser = new DOMParser();
      const doc = parser.parseFromString(text, 'text/html');
      const newContent = doc.querySelector('.shopify-section');
      
      if (newContent) {
        const miniCart = document.getElementById('mini-cart');
        if (miniCart) {
          miniCart.innerHTML = newContent.innerHTML;
        }
      }

      // –û–Ω–æ–≤–∏—Ç–∏ —ñ–∫–æ–Ω–∫—É –∫–æ—à–∏–∫–∞
      this.updateCartIcon();
      
      // –û–Ω–æ–≤–∏—Ç–∏ gift section –ø—ñ—Å–ª—è –∑–º—ñ–Ω –≤ –∫–æ—à–∏–∫—É
      this.updateGiftSection();
    } catch (error) {
      console.error('–ü–æ–º–∏–ª–∫–∞ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –∫–æ—à–∏–∫–∞:', error);
    }
  }

  updateGiftSection() {
    const giftSection = document.getElementById('gift-section');
    if (!giftSection) {
      this.createGiftSection();
      return;
    }

    const isGiftInCart = this.isGiftInCart();
    const emailSubmitted = sessionStorage.getItem('gift-email-submitted') === 'true';
    const giftClaimed = this.isGiftClaimed();
    
    // –ü–æ–∫–∞–∑–∞—Ç–∏ —Å–µ–∫—Ü—ñ—é —Ç—ñ–ª—å–∫–∏ —è–∫—â–æ –∫–∞—Å—Ç–æ–º–µ—Ä –º–∞—î –ø—Ä–∞–≤–æ –Ω–∞ –ø–æ–¥–∞—Ä—É–Ω–æ–∫ —ñ –Ω–µ–º–∞—î gift –≤ –∫–æ—à–∏–∫—É
    if ((emailSubmitted || giftClaimed) && !isGiftInCart) {
      giftSection.style.display = 'block';
      
      // –ü–æ–∫–∞–∑–∞—Ç–∏ –∫–Ω–æ–ø–∫—É –¥–ª—è –¥–æ–¥–∞–≤–∞–Ω–Ω—è –ø–æ–¥–∞—Ä—É–Ω–∫–∞
      giftSection.innerHTML = `
        <div class="gift-bundle-offer">
          <div class="gift-bundle-content">
            <div class="gift-bundle-text">
              <h4 class="gift-bundle-title">Free Gift Available</h4>
              <p class="gift-bundle-description">Add gift bundle to cart</p>
            </div>
          </div>
          <button class="button button--small button--cta gift-bundle-add" data-gift-bundle-add>
            <span class="label">Add Gift</span>
          </button>
        </div>
      `;
    } else {
      giftSection.style.display = 'none';
    }
  }

  createGiftSection() {
    // –°—Ç–≤–æ—Ä–∏—Ç–∏ gift section —è–∫—â–æ –π–æ–≥–æ –Ω–µ–º–∞—î
    const miniCartFooter = document.querySelector('.mini-cart__footer');
    if (miniCartFooter) {
      const giftSection = document.createElement('div');
      giftSection.className = 'mini-cart__gift-section';
      giftSection.id = 'gift-section';
      giftSection.innerHTML = `
        <style>
          .mini-cart__gift-section {
            margin: 16px 0;
            padding: 0 20px;
          }
          
          .gift-bundle-offer,
          .gift-bundle-added {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border: 2px solid #e6cedf;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            transition: all 0.3s ease;
          }
          
          .gift-bundle-added {
            border-color: #28a745;
            background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
          }
          
          .gift-bundle-content {
            display: flex;
            align-items: center;
            flex: 1;
          }
          
          .gift-bundle-icon {
            font-size: 28px;
            margin-right: 12px;
            animation: bounce 2s infinite;
          }
          
          .gift-bundle-text h4 {
            font-size: 14px;
            font-weight: 600;
            margin: 0 0 4px 0;
            color: #155724;
          }
          
          .gift-bundle-text p {
            font-size: 12px;
            margin: 0;
            color: #6c757d;
            line-height: 1.2;
          }
        </style>
      `;
      
      miniCartFooter.insertBefore(giftSection, miniCartFooter.firstChild);
    }
  }

  async updateCartIcon() {
    try {
      const response = await fetch('/cart.js');
      const cart = await response.json();
      
      const bubbles = document.querySelectorAll('.cart-count-bubble');
      bubbles.forEach(bubble => {
        bubble.textContent = cart.item_count;
        bubble.style.display = cart.item_count > 0 ? 'flex' : 'none';
      });
    } catch (error) {
      console.error('–ü–æ–º–∏–ª–∫–∞ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è —ñ–∫–æ–Ω–∫–∏ –∫–æ—à–∏–∫–∞:', error);
    }
  }

  showGiftAddedMessage() {
    // –ü–æ–∫–∞–∑–∞—Ç–∏ —Ç–∏–º—á–∞—Å–æ–≤–µ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è
    const message = document.createElement('div');
    message.style.cssText = `
      position: fixed;
      top: 20px;
      right: 20px;
      background: #28a745;
      color: white;
      padding: 16px 20px;
      border-radius: 8px;
      z-index: 9999;
      font-size: 14px;
      font-weight: 500;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    `;
    message.textContent = 'üéÅ Gift added to cart!';
    document.body.appendChild(message);

    setTimeout(() => {
      message.remove();
    }, 3000);
  }

  openMiniCart() {
    const miniCart = document.querySelector('mini-cart');
    if (miniCart && typeof miniCart.open === 'function') {
      miniCart.open();
    } else {
      // Fallback –¥–ª—è –≤—ñ–¥–∫—Ä–∏—Ç—Ç—è drawer
      const cartDrawer = document.querySelector('cart-drawer');
      if (cartDrawer) {
        cartDrawer.openMenuDrawer();
      }
    }
  }

  openGiftPopup() {
    console.log('üéÅ GiftBundleManager: openGiftPopup() called');
    const popup = document.querySelector('gift-popup');
    console.log('üéÅ GiftBundleManager: Gift popup element found:', !!popup);
    
    if (popup && typeof popup.open === 'function') {
      console.log('üéÅ GiftBundleManager: Opening popup via .open() method');
      popup.open();
    } else {
      console.log('üéÅ GiftBundleManager: Using alternative popup opening method');
      // –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–∏–π —Å–ø–æ—Å—ñ–± –≤—ñ–¥–∫—Ä–∏—Ç—Ç—è –ø–æ–ø–∞–ø–∞
      const popupElement = document.querySelector('.promo-popup');
      console.log('üéÅ GiftBundleManager: Promo popup element found:', !!popupElement);
      
      if (popupElement) {
        popupElement.classList.add('is-active');
        document.body.classList.add('promo-popup--open');
        console.log('üéÅ GiftBundleManager: Added active classes manually');
      }
    }
  }
}

// –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑—É–≤–∞—Ç–∏ –º–µ–Ω–µ–¥–∂–µ—Ä –≥—ñ—Ñ—Ç-–±–∞–Ω–¥–ª—É
document.addEventListener('DOMContentLoaded', () => {
  const manager = new GiftBundleManager();
  window.giftBundleManager = manager;
});

// –ï–∫—Å–ø–æ—Ä—Ç –¥–ª—è –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è –≤ —ñ–Ω—à–∏—Ö –º—ñ—Å—Ü—è—Ö
window.GiftBundleManager = GiftBundleManager;