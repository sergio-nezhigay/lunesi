{{ 'instagram-slider.css' | asset_url | stylesheet_tag }}

<div class="instagram-section instagram-section-{{ section.id }}"
  style="
    --section-padding-top: {{ section.settings.section_padding_top }}px;
    --section-padding-bottom: {{ section.settings.section_padding_bottom }}px;
    --title-size: {{ section.settings.title_size }}px;
    --title-weight: {{ section.settings.title_weight }};
    --title-color: {{ section.settings.title_color }};
    --button-text-color: {{ section.settings.button_text_color }};
    --button-border-color: {{ section.settings.button_border_color }};
    --button-hover-bg: {{ section.settings.button_hover_bg }};
    --button-hover-text: {{ section.settings.button_hover_text }};
    --arrow-background: {{ section.settings.arrow_background }};
    --arrow-border-color: {{ section.settings.arrow_border_color }};
    --arrow-color: {{ section.settings.arrow_color }};
    --arrow-hover-background: {{ section.settings.arrow_hover_background }};
    --arrow-hover-border: {{ section.settings.arrow_hover_border }};
    --arrow-hover-color: {{ section.settings.arrow_hover_color }};
    --overlay-opacity: {{ section.settings.overlay_opacity }};
    --hover-scale: {{ section.settings.hover_scale }};
    --background-color: {{ section.settings.background_color }};
  "
>
  <div class="instagram-wrapper">
    <div class="page-width">
      {% if section.settings.title != blank or section.settings.social_button_text != blank %}
        <div class="section-header">
          {% if section.settings.title != blank %}
            <h2 class="section-title">{{ section.settings.title }}</h2>
          {% endif %}
          
          {% if section.settings.social_button_text != blank and section.settings.social_url != blank %}
            <a href="{{ section.settings.social_url }}" class="social-button" target="_blank" rel="noopener">
              <span class="social-button-helper"></span>
              <span class="social-button-text">{{ section.settings.social_button_text }}</span>
            </a>
          {% endif %}
        </div>
      {% endif %}

      {% if section.blocks.size > 0 %}
        <div class="slider-container">
          <button class="nav-arrow prev">
            <svg viewBox="0 0 24 24">
              <path d="M15.41 16.59L10.83 12l4.58-4.59L14 6l-6 6 6 6 1.41-1.41z"/>
            </svg>
          </button>

          <div class="slider-wrapper">
            <div class="slider-track">
              {% for block in section.blocks %}
                <div class="slide" {{ block.shopify_attributes }}>
                  {% if block.settings.image != blank %}
                    {{ block.settings.image | image_url: width: 400, height: 400, crop: 'center' | image_tag: 
                       alt: block.settings.alt_text, 
                       loading: 'lazy',
                       width: 400,
                       height: 400 }}
                    
                    <div class="slide-overlay">
                      {% if block.settings.instagram_url != blank %}
                        <a href="{{ block.settings.instagram_url }}" class="view-instagram" target="_blank" rel="noopener">
                          <svg class="instagram-icon-white" viewBox="0 0 24 24">
                            <path d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zm0-2.163c-3.259 0-3.667.014-4.947.072-4.358.2-6.78 2.618-6.98 6.98-.059 1.281-.073 1.689-.073 4.948 0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98 1.281.058 1.689.072 4.948.072 3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98-1.281-.059-1.69-.073-4.949-.073zm0 5.838c-3.403 0-6.162 2.759-6.162 6.162s2.759 6.163 6.162 6.163 6.162-2.759 6.162-6.163c0-3.403-2.759-6.162-6.162-6.162zm0 10.162c-2.209 0-4-1.79-4-4 0-2.209 1.791-4 4-4s4 1.791 4 4c0 2.21-1.791 4-4 4zm6.406-11.845c-.796 0-1.441.645-1.441 1.44s.645 1.44 1.441 1.44c.795 0 1.439-.645 1.439-1.44s-.644-1.44-1.439-1.44z"/>
                          </svg>
                          {{ section.settings.view_instagram_text | default: 'View on Instagram' }}
                        </a>
                      {% endif %}
                    </div>
                  {% else %}
                    <div class="slide-placeholder"></div>
                  {% endif %}
                </div>
              {% endfor %}
            </div>
          </div>

          <button class="nav-arrow next">
            <svg viewBox="0 0 24 24">
              <path d="M8.59 16.59L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.41z"/>
            </svg>
          </button>
        </div>
      {% endif %}
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  initInstagramSlider();
});

function initInstagramSlider() {
  const sliderContainer = document.querySelector('.instagram-section .slider-container');
  if (!sliderContainer) return;

  const sliderTrack = sliderContainer.querySelector('.slider-track');
  const slides = sliderContainer.querySelectorAll('.slide');
  const prevBtn = sliderContainer.querySelector('.nav-arrow.prev');
  const nextBtn = sliderContainer.querySelector('.nav-arrow.next');
  
  if (!sliderTrack || !slides.length) return;

  let currentSlide = 0;
  const totalSlides = slides.length;

  function getSlidesPerView() {
    const width = window.innerWidth;
    if (width >= 1024) return 3.5;
    if (width >= 768) return 2.5;
    return 1.5;
  }

  function getSlideWidth() {
    const slide = slides[0];
    if (!slide) return 0;
    
    const slideWidth = slide.offsetWidth;
    const gap = window.innerWidth <= 767 ? 12 : 20;
    
    return slideWidth + gap;
  }

  function updateSlider() {
    const slideWidth = getSlideWidth();
    const translateX = -currentSlide * slideWidth;
    sliderTrack.style.transform = `translateX(${translateX}px)`;
    updateNavigation();
  }

  function updateNavigation() {
    const slidesPerView = getSlidesPerView();
    const maxSlide = Math.max(0, totalSlides - Math.floor(slidesPerView));
    
    if (prevBtn) {
      prevBtn.disabled = currentSlide <= 0;
      prevBtn.style.opacity = currentSlide <= 0 ? '0.3' : '1';
    }
    if (nextBtn) {
      nextBtn.disabled = currentSlide >= maxSlide;
      nextBtn.style.opacity = currentSlide >= maxSlide ? '0.3' : '1';
    }
  }

  function nextSlide(e) {
    if (e) {
      e.preventDefault();
      e.stopPropagation();
    }
    const slidesPerView = getSlidesPerView();
    const maxSlide = Math.max(0, totalSlides - Math.floor(slidesPerView));
    if (currentSlide < maxSlide) {
      currentSlide++;
      updateSlider();
    }
  }

  function prevSlide(e) {
    if (e) {
      e.preventDefault();
      e.stopPropagation();
    }
    if (currentSlide > 0) {
      currentSlide--;
      updateSlider();
    }
  }

  if (prevBtn) {
    prevBtn.addEventListener('click', prevSlide);
    prevBtn.addEventListener('touchstart', function(e) {
      e.preventDefault();
      e.stopPropagation();
      prevSlide(e);
    }, { passive: false });
  }
  
  if (nextBtn) {
    nextBtn.addEventListener('click', nextSlide);
    nextBtn.addEventListener('touchstart', function(e) {
      e.preventDefault();
      e.stopPropagation();
      nextSlide(e);
    }, { passive: false });
  }

  let startX = 0;
  let startY = 0;
  let isDragging = false;
  let hasMoved = false;

  sliderTrack.addEventListener('touchstart', (e) => {
    startX = e.touches[0].clientX;
    startY = e.touches[0].clientY;
    isDragging = false;
    hasMoved = false;
  }, { passive: true });

  sliderTrack.addEventListener('touchmove', (e) => {
    if (!startX || !startY) return;
    
    const currentX = e.touches[0].clientX;
    const currentY = e.touches[0].clientY;
    const diffX = Math.abs(currentX - startX);
    const diffY = Math.abs(currentY - startY);
    
    if (diffX > diffY && diffX > 10) {
      isDragging = true;
      hasMoved = true;
      e.preventDefault();
    }
  }, { passive: false });

  sliderTrack.addEventListener('touchend', (e) => {
    if (!isDragging || !hasMoved) return;
    
    const endX = e.changedTouches[0].clientX;
    const diffX = startX - endX;
    
    if (Math.abs(diffX) > 30) {
      diffX > 0 ? nextSlide() : prevSlide();
    }
    
    startX = 0;
    startY = 0;
    isDragging = false;
    hasMoved = false;
  }, { passive: true });

  slides.forEach(slide => {
    const instagramLink = slide.querySelector('.view-instagram');
    if (instagramLink) {
      instagramLink.addEventListener('click', function(e) {
        if (hasMoved) {
          e.preventDefault();
          e.stopPropagation();
          return false;
        }
      });
    }
  });

  let resizeTimeout;
  window.addEventListener('resize', () => {
    clearTimeout(resizeTimeout);
    resizeTimeout = setTimeout(() => {
      currentSlide = 0;
      updateSlider();
    }, 250);
  });
  
  updateSlider();

  const socialBtn = document.querySelector('.instagram-section .social-button');
  if (socialBtn) {
    let animationTimeout;
    
    function getDirection(e) {
      const rect = socialBtn.getBoundingClientRect();
      const x = e.clientX - (rect.left + rect.width/2);
      const y = e.clientY - (rect.top + rect.height/2);
      return Math.abs(x) > Math.abs(y) ? (x > 0 ? 'right' : 'left') : (y > 0 ? 'bottom' : 'top');
    }
    
    socialBtn.addEventListener('mouseenter', (e) => {
      clearTimeout(animationTimeout);
      socialBtn.className = socialBtn.className.replace(/\b(from|exit|hover)-\w+/g, '');
      const dir = getDirection(e);
      socialBtn.classList.add(`from-${dir}`);
      
      requestAnimationFrame(() => {
        requestAnimationFrame(() => {
          socialBtn.classList.add('hover-active');
          socialBtn.classList.remove(`from-${dir}`);
        });
      });
    });
    
    socialBtn.addEventListener('mouseleave', (e) => {
      socialBtn.classList.remove('hover-active');
      const dir = getDirection(e);
      socialBtn.classList.add(`exit-${dir}`);
      
      animationTimeout = setTimeout(() => {
        socialBtn.classList.remove(`exit-${dir}`);
        socialBtn.classList.add('exit-complete');
      }, 300);
    });
  }
}
</script>

{% schema %}
{
  "name": "Instagram Slider",
  "tag": "section",
  "class": "instagram-slider-section",
  "settings": [
    {
      "type": "header",
      "content": "Section Settings"
    },
    {
      "type": "text",
      "id": "title",
      "label": "Section Title",
      "default": "You + Lunesi"
    },
    {
      "type": "range",
      "id": "title_size",
      "label": "Title Font Size",
      "min": 24,
      "max": 60,
      "step": 2,
      "default": 42,
      "unit": "px"
    },
    {
      "type": "select",
      "id": "title_weight",
      "label": "Title Font Weight",
      "default": "400",
      "options": [
        { "value": "300", "label": "Light" },
        { "value": "400", "label": "Normal" },
        { "value": "500", "label": "Medium" },
        { "value": "600", "label": "Semi Bold" }
      ]
    },
    {
      "type": "color",
      "id": "title_color",
      "label": "Title Color",
      "default": "#1a1a1a"
    },
    {
      "type": "header",
      "content": "Social Button"
    },
    {
      "type": "text",
      "id": "social_button_text",
      "label": "Social Button Text",
      "default": "Find us on social"
    },
    {
      "type": "url",
      "id": "social_url",
      "label": "Social Media URL",
      "info": "Link to your Instagram profile"
    },
    {
      "type": "color",
      "id": "button_text_color",
      "label": "Button Text Color",
      "default": "#1a1a1a"
    },
    {
      "type": "color",
      "id": "button_border_color",
      "label": "Button Border Color",
      "default": "#1a1a1a"
    },
    {
      "type": "color",
      "id": "button_hover_bg",
      "label": "Button Hover Background",
      "default": "#6b6b6b"
    },
    {
      "type": "color",
      "id": "button_hover_text",
      "label": "Button Hover Text Color",
      "default": "#ffffff"
    },
    {
      "type": "header",
      "content": "Navigation Arrows"
    },
    {
      "type": "color",
      "id": "arrow_background",
      "label": "Arrow Background",
      "default": "#ffffff"
    },
    {
      "type": "color",
      "id": "arrow_border_color",
      "label": "Arrow Border Color",
      "default": "#d1d1d1"
    },
    {
      "type": "color",
      "id": "arrow_color",
      "label": "Arrow Icon Color",
      "default": "#1a1a1a"
    },
    {
      "type": "color",
      "id": "arrow_hover_background",
      "label": "Arrow Hover Background",
      "default": "#1a1a1a"
    },
    {
      "type": "color",
      "id": "arrow_hover_border",
      "label": "Arrow Hover Border",
      "default": "#1a1a1a"
    },
    {
      "type": "color",
      "id": "arrow_hover_color",
      "label": "Arrow Hover Icon Color",
      "default": "#ffffff"
    },
    {
      "type": "header",
      "content": "Image Settings"
    },
    {
      "type": "text",
      "id": "view_instagram_text",
      "label": "Instagram Link Text",
      "default": "View on Instagram"
    },
    {
      "type": "range",
      "id": "overlay_opacity",
      "label": "Overlay Opacity",
      "min": 0.3,
      "max": 0.8,
      "step": 0.1,
      "default": 0.6
    },
    {
      "type": "range",
      "id": "hover_scale",
      "label": "Image Hover Scale",
      "min": 1.0,
      "max": 1.2,
      "step": 0.1,
      "default": 1.1
    },
    {
      "type": "header",
      "content": "Section Spacing"
    },
    {
      "type": "range",
      "id": "section_padding_top",
      "label": "Section Padding Top",
      "min": 0,
      "max": 120,
      "step": 8,
      "default": 80,
      "unit": "px"
    },
    {
      "type": "range",
      "id": "section_padding_bottom",
      "label": "Section Padding Bottom",
      "min": 0,
      "max": 120,
      "step": 8,
      "default": 80,
      "unit": "px"
    },
    {
      "type": "color",
      "id": "background_color",
      "label": "Background Color",
      "default": "#fefefe"
    }
  ],
  "blocks": [
    {
      "type": "instagram_image",
      "name": "Instagram Image",
      "settings": [
        {
          "type": "image_picker",
          "id": "image",
          "label": "Image"
        },
        {
          "type": "text",
          "id": "alt_text",
          "label": "Alt Text",
          "info": "Describe the image for accessibility"
        },
        {
          "type": "url",
          "id": "instagram_url",
          "label": "Instagram Post URL",
          "info": "Link to the Instagram post"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Instagram Slider",
      "blocks": [
        {
          "type": "instagram_image"
        },
        {
          "type": "instagram_image"
        },
        {
          "type": "instagram_image"
        },
        {
          "type": "instagram_image"
        },
        {
          "type": "instagram_image"
        },
        {
          "type": "instagram_image"
        }
      ]
    }
  ]
}
{% endschema %}