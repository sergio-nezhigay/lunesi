<style>
  .main_image_header {
    width: 50px !important;
    height: auto;
  }
  .mini-cart .cart__discount {
    align-items: center !important;
    gap: 8px;
  }

  #discount-apply-btn-drawer {
    background: none;
    border-radius: 10px;
    border: none;
    font-family: var(--font-button-family);
    box-shadow: inset 0 0 0 .1rem rgb(var(--color-border));
    color: rgb(var(--color-foreground));
    padding: 1rem 1.5rem;
    font-size: 12px;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    cursor: pointer;
    min-width: 80px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
  }


  #discount-apply-btn-drawer:disabled {
    opacity: 0.6;
    cursor: wait;
  }

  #discount-apply-btn-drawer .btn-spinner {
    width: 16px;
    height: 16px;
    border: 2px solid rgba(0, 0, 0, 0.2);
    border-top-color: rgb(var(--color-foreground));
    border-radius: 50%;
    animation: btn-spin 0.6s linear infinite;
  }

  @keyframes btn-spin {
    to { transform: rotate(360deg); }
  }

  .cart__discount-wrapper {
    width: 100%;
  }

  #discount-code-input-drawer {
    border-radius: 10px;
  }

  /* GB Promo Gift Banner */
  .gb-promo-gift {
    list-style: none;
    padding: 1.2rem 1.5rem;
    border-bottom: 0.1rem solid rgb(var(--color-border));
    background-color: rgb(var(--color-base-background));
  }

  .gb-promo-gift__content {
    display: flex;
    align-items: center;
    gap: 1.2rem;
  }

  .gb-promo-gift__image-wrap {
    width: 70px;
    height: 70px;
    flex-shrink: 0;
    overflow: hidden;
    border-radius: var(--card-radius, 4px);
  }

  .gb-promo-gift__image {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .gb-promo-gift__info {
    flex: 1;
    min-width: 0;
  }

  .gb-promo-gift__title {
    display: block;
    font-weight: 500;
    line-height: 1.3;
    margin-bottom: 0.2rem;
  }

  a.gb-promo-gift__image-wrap {
    display: block;
  }

  .gb-promo-gift__price {
    display: block;
    font-size: 1.1rem;
    color: rgb(var(--color-success));
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  .gb-promo-gift__btn {
    background: #212326;
    color: #fff !important;
    border: none;
    border-radius: var(--button-radius, 4px);
    padding: 0.7rem 1.2rem;
    font-size: 1.2rem;
    font-family: var(--font-button-family);
    cursor: pointer;
    white-space: nowrap;
    flex-shrink: 0;
    transition: opacity 0.2s ease, color 0.2s ease;
  }

  .gb-promo-gift__btn:hover {
    opacity: 0.8;
  }

  .gb-promo-gift__btn:disabled {
    opacity: 0.5;
    cursor: wait;
  }

  .gb-promo-gift__btn.loading {
    color: transparent !important;
    position: relative;
    opacity: 1;
  }

  .gb-promo-gift__btn.loading::after {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    width: 16px;
    height: 16px;
    margin: -8px 0 0 -8px;
    border: 2px solid #fff;
    border-right-color: transparent;
    border-radius: 50%;
    animation: gb-gift-spin 0.6s linear infinite;
  }

  @keyframes gb-gift-spin {
    to { transform: rotate(360deg); }
  }
</style>
{% comment %}theme-check-disable TemplateLength{% endcomment %}
{%- liquid
  if linklists['gift-wrapping'].links != blank and linklists['gift-wrapping'].links.first.type == 'product_link'
    assign gift_wrapping = linklists['gift-wrapping'].links.first

    assign gift_wrap_id = gift_wrapping.object.variants.first.id
    assign gift_wraps_in_cart = 0
    for item in cart.items
      if item.id == gift_wrap_id
        assign gift_wraps_in_cart = item.quantity
        break
      endif
    endfor
    assign items_in_cart = cart.item_count | minus: gift_wraps_in_cart
  endif

  assign animate_count = 1
-%}

<form
  class="mini-cart{% if cart == empty %} is-empty{% endif %}"
  action="{{ routes.cart_url }}"
  method="post"
  id="cart"
>
  <div class="mini-cart__inner">
    <div class="mini-cart__header" data-animate data-animate-delay-{{ animate_count }}>
      <drawer-close-button class="header__icon header__icon--summary header__icon--cart">
        <svg class="icon icon-close" aria-hidden="true" focusable="false">
          <use href="#icon-close"></use>
        </svg>
      </drawer-close-button>
      <div class="title h4">{{ 'sections.cart.title' | t }}</div>
      {%- liquid
        if settings.show_free_shipping_message and settings.free_shipping_minimum_amount != blank
          assign free_shipping_minimum_amounts = settings.free_shipping_minimum_amount | remove: ' ' | split: ','
          assign show_free_shipping_message = false

          if free_shipping_minimum_amounts.size > 1
            for minimum_amount in free_shipping_minimum_amounts
              assign minimum_amount_parts = minimum_amount | split: ':'
              assign currency_code = minimum_amount_parts | first | upcase
              if currency_code == cart.currency.iso_code
                assign free_shipping_minimum_amount = minimum_amount_parts | last
                assign show_free_shipping_message = true
                break
              endif
            endfor
          else
            assign free_shipping_minimum_amount = free_shipping_minimum_amounts | last
            if free_shipping_minimum_amount contains ':'
              assign free_shipping_minimum_amount = free_shipping_minimum_amounts | split: ':' | last
            endif
            assign show_free_shipping_message = true
          endif

          if show_free_shipping_message
            render 'free-shipping', minimum_amount: free_shipping_minimum_amount
          endif
        endif
      -%}
      <span class="mini-cart__border"></span>

      {%- liquid
        # Gift logic variables
        assign gift_variant_id = 43694372257923
        assign gift_in_cart = false
        assign non_gift_items_count = 0

        for item in cart.items
          if item.variant_id == gift_variant_id
            assign gift_in_cart = true
          else
            assign non_gift_items_count = non_gift_items_count | plus: item.quantity
          endif
        endfor
      -%}

      {%- comment -%} –ü–æ–∫–∞–∑–∞—Ç—å free shipping bar —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –≤ –∫–æ—Ä–∑–∏–Ω–µ –º–∏–Ω–∏–º—É–º 1 –ø—Ä–æ–¥—É–∫—Ç {%- endcomment -%}
      {% if settings.free_shipping_bar_enable
        and non_gift_items_count >= 1
        and non_gift_items_count < 2
        or gift_in_cart
      %}
        {%- liquid
          assign free_shipping_threshold = settings.free_shipping_bar_threshold | default: 2
          assign gift_variant_id_for_shipping = 43694372257923
          assign current_items = cart.item_count

          # Exclude gift wrapping
          if gift_wraps_in_cart
            assign current_items = current_items | minus: gift_wraps_in_cart
          endif

          # Exclude gift set from count
          for item in cart.items
            if item.variant_id == gift_variant_id_for_shipping
              assign current_items = current_items | minus: item.quantity
              break
            endif
          endfor

          
          assign progress_percentage = current_items | times: 100 | divided_by: free_shipping_threshold
          if progress_percentage > 100
            assign progress_percentage = 100
          endif
        -%}

        <style>
          .free-shipping-bar {
            margin-top: 24px;
            background: {{ settings.free_shipping_bar_bg_color | default: '#F7F7F7' }};
            border-radius: 8px;
            padding: 14px 16px;
            margin-bottom: 18px;
            text-align: center;
            border: 1px solid rgba(198, 206, 223, 0.2);
          }

          .item-count {
            font-size: 15px;
            font-weight: 500;
            color: {{ settings.free_shipping_item_count_color | default: '#282828' }};
            display: block;
            letter-spacing: 0.2px;
            display: none;
          }

          .progress-container {
            margin: 10px 0;
          }

          .progress-track {
            height: 8px;
            background: linear-gradient(90deg, #EFEFEF 0%, #E8E8E8 100%);
            border-radius: 4px;
            overflow: hidden;
            position: relative;
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.05);
          }

          .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, {{ settings.free_shipping_progress_color | default: '#D2D5D9' }} 0%, {{ settings.free_shipping_progress_color | default: '#D2D5D9' | color_modify: 'alpha', 0.8 }} 100%);
            border-radius: 4px;
            transition: width 0.8s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
            display: block !important;
          }

          .progress-fill.success {
            background: linear-gradient(90deg, {{ settings.free_shipping_progress_success_color | default: '#4CAF50' }} 0%, {{ settings.free_shipping_progress_success_color | default: '#4CAF50' | color_modify: 'alpha', 0.8 }} 100%) !important;
          }

          .progress-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
            transform: translateX(-100%);
            animation: progressGlow 2s infinite;
          }

          @keyframes progressGlow {
            0% {
              transform: translateX(-100%);
              opacity: 0;
            }
            50% {
              opacity: 1;
            }
            100% {
              transform: translateX(100%);
              opacity: 0;
            }
          }

          .shipping-message {
            font-size: 13px;
            color: {{ settings.free_shipping_message_color | default: '#282828' }};
            font-weight: 400;
            line-height: 1.3;
          }

          .message-success {
            color: {{ settings.free_shipping_success_color | default: '#4A5568' }} !important;
            font-weight: 500;
          }

          @media screen and (max-width: 420px) {
            .free-shipping-bar {
              padding: 10px 14px;
              margin: 10px 0 0;
            }

            .item-count {
              font-size: 14px;
              margin-bottom: 8px;
            }

            .progress-track {
              height: 6px;
            }

            .progress-container {
              margin-bottom: 8px;
            }

            .shipping-message {
              font-size: 12px;
            }
          }
        </style>
        {% comment %} {% render 'free-shipping', minimum_amount: settings.free_shipping_minimum_amount %} {% endcomment %}

        {% comment %} {% render 'component-free-shipping', minimum_amount: section.settings.minimum_amount settings.free_shipping_minimum_amount %} {% endcomment %}

        {% comment %}
          <div class="free-shipping-bar">
            <div class="shipping-info">
              <span class="item-count">{{ current_items }} item{% if current_items != 1 %}s{% endif %}</span>
            </div>
            <div class="shipping-message">
              {%- if current_items >= free_shipping_threshold -%}
                {%- comment -%} –°–∫—Ä—ã—Ç—å success message –µ—Å–ª–∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É ADD GIFT {%- endcomment -%}
                {%- unless non_gift_items_count >= 2 and gift_in_cart == false -%}
                  <span class="message-success">{{ settings.free_shipping_success_text | default: 'FREE shipping Royal Mail unlocked!' }}</span>
                {%- endunless -%}
              {%- else -%}
                {%- assign items_needed_suffix = '' -%}
                {%- if items_needed != 1 -%}
                  {%- assign items_needed_suffix = 's' -%}
                {%- endif -%}
                {%- assign default_text = 'Add [items_needed] item[s] more for FREE shipping Royal Mail' -%}
                {%- assign message_text = settings.free_shipping_need_more_text | default: default_text -%}
                <span>{{ message_text | replace: '[items_needed]', items_needed | replace: '[s]', items_needed_suffix }}</span>
              {%- endif -%}
            </div>

            <div class="progress-container">
              <div class="progress-track">
                <div class="progress-fill{% if current_items >= free_shipping_threshold %} success{% endif %}" style="width: {{ progress_percentage }}%"></div>
              </div>
            </div>


          </div>
        {% endcomment %}
      {%- endif -%}

      {%- comment -%} Gift section - visibility controlled by JavaScript {%- endcomment -%}
      {%- comment -%}
        {%- liquid
          assign should_show_gift = false
          if cart != empty and non_gift_items_count >= 2 and gift_in_cart == false
            assign should_show_gift = true
          endif
        -%}
           <div class="mini-cart__gift-section" id="gift-section" style="display: {% if should_show_gift %}block{% else %}none{% endif %}; margin: 20px 0 16px 0;" data-mini-gift-offer>
            <div class="gift-claim-container">
              <div class="gift-claim-content">
                <div class="gift-icon">{{ settings.main_products.featured_image | image_url: width: settings.main_products.featured_image.widthsettings.main_products.featured_image | image_tag: class: "main_image_header" }}</div>
                <div class="gift-text">
                  <h4 class="gift-title">{{settings.main_products.title}}</h4>
                </div>
              </div>
              <button class="button button--gift" data-id={{ settings.main_products.variants.first.id }} data-gift-add>
                ADD GIFT
              </button>
            </div>
          </div>
          <script>
            const productId = {{ product.variants.first.id }};
            const productHandle = "{{ product.handle }}";
          </script>
      {%- endcomment -%}
      {% comment %}
        <div class="mini-cart__gift-section" id="gift-section" style="display: block; margin: 20px 0 16px 0;">
          <div class="gift-claim-container">
            <div class="gift-claim-content">
              <div class="gift-icon">üéÅ</div>
              <div class="gift-text">
                <h4 class="gift-title">Free Gift Available</h4>
                <p class="gift-description">Add your gift bundle to cart</p>
              </div>
            </div>
            <button class="button button--gift" data-gift-add>
              ADD GIFT
            </button>
          </div>
        </div>
      {% endcomment %}
    </div>
    <div class="mini-cart__empty center" data-animate data-animate-delay-{{ animate_count }}>
      {% comment %} <p class="mini-cart__empty-text h3">{{ 'sections.cart.empty' | t }}</p> {% endcomment %}
      <div class="mini-cart__empty-message typeset">{{ settings.empty_cart_message }}</div>
      {%- if settings.empty_cart_collections == blank -%}
        <a
          href="{{ shop.url }}{{ settings.empty_cart_redirect_url | default: routes.all_products_collection_url }}"
          class="button{% if settings.empty_cart_button_secondary %} button--tertiary{% endif %}"
        >
          {{- 'general.continue_shopping' | t -}}
        </a>
      {%- else -%}
        <ul class="mini-cart__empty-collections list-unstyled">
          {%- for collection_card in settings.empty_cart_collections -%}
            <li>
              <a
                href="{{ shop.url }}{{ collection_card.url }}"
                class="button{% if settings.empty_cart_button_secondary %} button--tertiary{% endif %} button--full-width"
              >
                {{- collection_card.title | escape -}}
              </a>
            </li>
          {%- endfor -%}
        </ul>
      {%- endif -%}
    </div>

    {%- if cart == empty
      and settings.cart_recommendations_enabled
      and settings.cart_recommendations_products != blank
    -%}
      {%- assign animate_count = animate_count | plus: 1 -%}
      <div class="cart-recommendations" data-animate data-animate-delay-{{ animate_count }}>
        <div class="title h4">{{ settings.cart_recommendations_heading | escape }}</div>
        <ul class="mini-cart__navigation">
          {%- for recommendation in settings.cart_recommendations_products -%}
            <li>
              <div class="product-container product-container--link{% unless recommendation.featured_media %} no-image{% endunless %}">
                {% if recommendation.featured_media %}
                  <div class="product-image">
                    <a href="{{ shop.url }}{{ recommendation.url }}" class="media-wrapper media-wrapper--small">
                      <div
                        class="media media--adapt"
                        style="--image-ratio-percent: {{ 1 | divided_by: recommendation.featured_media.aspect_ratio | times: 100 }}%;"
                      >
                        <img
                          srcset="{{ recommendation.featured_media | image_url: width: 70 }} 1x, {{ recommendation.featured_media | image_url: width: 140 }} 2x"
                          src="{{ recommendation.featured_media | image_url: width: 70 }}"
                          alt="{{ recommendation.featured_media.alt | escape | split: '#' | first }}"
                          width="70"
                          height="{{ 70 | divided_by: recommendation.featured_media.aspect_ratio | ceil }}"
                          loading="lazy"
                          is="lazy-image"
                        >
                      </div>
                    </a>
                  </div>
                {% endif %}
                <div class="product-description">
                  {%- if settings.cart_recommendations_show_vendor -%}
                    <span class="visually-hidden">{{ 'accessibility.vendor' | t }}</span>
                    <div class="caption-with-letter-spacing">{{ recommendation.vendor }}</div>
                  {%- endif -%}
                  <div class="product-content">
                    <a href="{{ shop.url }}{{ recommendation.url }}" class="link product-title">{{ recommendation.title }}</a>
                  </div>
                  {%- if settings.cart_recommendations_show_price -%}
                    {% render 'price', product: recommendation %}

                    <div class="product-button">
                      {%- if recommendation.available and recommendation.variants.size == 1 -%}
                        <add-to-cart
                          class="button button--small button--cta"
                          data-variant-id="{{ recommendation.selected_or_first_available_variant.id }}"
                        >
                          <span class="small-hide">
                            <span class="label">
                              {%- liquid
                                if recommendation.template_suffix != 'pre-order'
                                  echo 'products.product.add_to_cart' | t
                                else
                                  echo 'products.product.pre_order' | t
                                endif
                              -%}
                            </span>
                            {% render 'icon', icon: 'arrow' %}
                          </span>
                          <svg class="icon icon-cart medium-hide large-up-hide" aria-hidden="true" focusable="false">
                            <use href="#icon-cart"></use>
                          </svg>
                        </add-to-cart>
                      {%- else -%}
                        <a href="{{ shop.url }}{{ recommendation.url }}" class="button button--small button--cta" tabindex="-1">
                          <span class="small-hide">
                            <span class="label">
                              {%- liquid
                                if recommendation.available
                                  echo 'products.product.choose_options' | t
                                else
                                  echo 'products.product.view' | t
                                endif
                              -%}
                            </span>
                            {% render 'icon', icon: 'arrow' %}
                          </span>
                          <svg class="icon icon-cart medium-hide large-up-hide" aria-hidden="true" focusable="false">
                            <use href="#icon-cart"></use>
                          </svg>
                        </a>
                      {%- endif -%}
                    </div>
                  {%- endif -%}
                </div>
              </div>
            </li>
          {%- endfor -%}
        </ul>
      </div>
    {%- endif -%}

    <div class="mini-cart__main" id="main-cart-items">
      {%- if cart != empty and settings.cart_recommendations_enabled -%}
        {%- liquid
          assign cart_recommendations_limit = 4
          if settings.cart_recommendations_products != blank
            assign cart_recommendations_limit = settings.cart_recommendations_products.count
          endif
        -%}
        <cart-recommendations
          class="cart-recommendations"
          data-url="{{ shop.url }}{{ routes.product_recommendations_url }}?section_id={{ section.id }}&product_id={{ cart.items.first.product_id }}&limit={{ cart_recommendations_limit }}"
          data-animate
          data-animate-delay-{{ animate_count }}
        >
          <div class="title h4">{{ settings.cart_recommendations_heading | escape }}</div>
          <ul class="mini-cart__navigation">
            {%- for recommendation in recommendations.products -%}
              <li>
                <div class="product-container product-container--link{% unless recommendation.featured_media %} no-image{% endunless %}">
                  {% if recommendation.featured_media %}
                    <div class="product-image">
                      <a href="{{ shop.url }}{{ recommendation.url }}" class="media-wrapper media-wrapper--small">
                        <div
                          class="media media--adapt"
                          style="--image-ratio-percent: {{ 1 | divided_by: recommendation.featured_media.aspect_ratio | times: 100 }}%;"
                        >
                          <img
                            srcset="{{ recommendation.featured_media | image_url: width: 70 }} 1x, {{ recommendation.featured_media | image_url: width: 140 }} 2x"
                            src="{{ recommendation.featured_media | image_url: width: 70 }}"
                            alt="{{ recommendation.featured_media.alt | escape | split: '#' | first }}"
                            width="70"
                            height="{{ 70 | divided_by: recommendation.featured_media.aspect_ratio | ceil }}"
                            loading="lazy"
                            is="lazy-image"
                          >
                        </div>
                      </a>
                    </div>
                  {% endif %}
                  <div class="product-description">
                    {%- if settings.cart_recommendations_show_vendor -%}
                      <span class="visually-hidden">{{ 'accessibility.vendor' | t }}</span>
                      <div class="caption-with-letter-spacing">{{ recommendation.vendor }}</div>
                    {%- endif -%}
                    <div class="product-content">
                      <a href="{{ shop.url }}{{ recommendation.url }}" class="link product-title">{{ recommendation.title }}</a>
                    </div>
                    {%- if settings.cart_recommendations_show_price -%}
                      {% render 'price', product: recommendation %}

                      <div class="product-button">
                        {%- if recommendation.available and recommendation.variants.size == 1 -%}
                          <add-to-cart
                            class="button button--small button--cta"
                            data-variant-id="{{ recommendation.selected_or_first_available_variant.id }}"
                          >
                            <span class="small-hide">
                              <span class="label">
                                {%- liquid
                                  if recommendation.template_suffix != 'pre-order'
                                    echo 'products.product.add_to_cart' | t
                                  else
                                    echo 'products.product.pre_order' | t
                                  endif
                                -%}
                              </span>
                              {% render 'icon', icon: 'arrow' %}
                            </span>
                            <svg class="icon icon-cart medium-hide large-up-hide" aria-hidden="true" focusable="false">
                              <use href="#icon-cart"></use>
                            </svg>
                          </add-to-cart>
                        {%- else -%}
                          <a href="{{ shop.url }}{{ recommendation.url }}" class="button button--small button--cta" tabindex="-1">
                            <span class="small-hide">
                              <span class="label">
                                {%- liquid
                                  if recommendation.available
                                    echo 'products.product.choose_options' | t
                                  else
                                    echo 'products.product.view' | t
                                  endif
                                -%}
                              </span>
                              {% render 'icon', icon: 'arrow' %}
                            </span>
                            <svg class="icon icon-cart medium-hide large-up-hide" aria-hidden="true" focusable="false">
                              <use href="#icon-cart"></use>
                            </svg>
                          </a>
                        {%- endif -%}
                      </div>
                    {%- endif -%}
                  </div>
                </div>
              </li>
            {%- endfor -%}
          </ul>
        </cart-recommendations>
      {%- endif -%}

      <cart-items>
        {%- assign animate_count = animate_count | plus: 1 -%}
        <ul class="mini-cart__navigation" data-animate data-animate-delay-{{ animate_count }}>
          {%- liquid
            assign gb_promo_gift_product = settings.gb_promo_gift_product
            assign gb_promo_variant_id = gb_promo_gift_product.variants.first.id | plus: 0
            assign gb_promo_gift_in_cart = false
            assign gb_promo_has_regular_items = false
            if settings.gb_promo_gift_enabled and localization.country.iso_code == 'GB' and gb_promo_variant_id != 0
              for item in cart.items
                if item.variant_id == gb_promo_variant_id
                  assign gb_promo_gift_in_cart = true
                else
                  assign gb_promo_has_regular_items = true
                endif
              endfor
            endif
          -%}
          {%- if settings.gb_promo_gift_enabled
            and localization.country.iso_code == 'GB'
            and gb_promo_variant_id != 0
            and gb_promo_has_regular_items
            and gb_promo_gift_in_cart == false
          -%}
            <li class="gb-promo-gift">
              <div class="gb-promo-gift__content">
                {%- if gb_promo_gift_product.featured_image != blank -%}
                  <a href="{{ gb_promo_gift_product.url }}" class="gb-promo-gift__image-wrap">
                    {{ gb_promo_gift_product.featured_image | image_url: width: 140 | image_tag:
                      class: 'gb-promo-gift__image',
                      loading: 'lazy',
                      sizes: '70px',
                      widths: '70, 140'
                    }}
                  </a>
                {%- endif -%}
                <div class="gb-promo-gift__info">
                  <a href="{{ gb_promo_gift_product.url }}" class="gb-promo-gift__title link">{{ gb_promo_gift_product.title }}</a>
                  <span class="gb-promo-gift__price">FREE</span>
                </div>
                <button class="gb-promo-gift__btn" type="button">
                  {{ settings.gb_promo_gift_button_text | default: 'Add Free Gift' }}
                </button>
              </div>
            </li>
          {%- endif -%}

          {%- for item in cart.items -%}
            <li
              class="cart-item"
              data-variant-id="{{ item.variant_id }}"
              data-product-id="{{ item.product.id }}"
              data-handle="{{ item.product.handle }}"
              data-quantity="{{ item.quantity }}"
              data-price="{{ item.original_price }}"
            >
              <div class="loading-overlay hidden">
                <div class="loading-overlay__spinner">
                  {% render 'icon', icon: 'spinner' %}
                </div>
              </div>
              {%- liquid
                # Hide remove button for gift wrapping and Buy X Get Y gift items
                assign hide_remove_button = false
                if gift_wrap_id and item.id == gift_wrap_id
                  assign hide_remove_button = true
                endif

                # Check if this is a Buy X Get Y gift item
                assign bxgy_gift_1_id = settings.buy_x_get_y_gift_variant_1 | plus: 0
                assign bxgy_gift_2_id = settings.buy_x_get_y_gift_variant_2 | plus: 0
                if item.variant_id == bxgy_gift_1_id or item.variant_id == bxgy_gift_2_id
                  assign hide_remove_button = true
                endif

                # Check if this is a GB Promo Gift item
                assign gb_promo_variant_chk = settings.gb_promo_gift_product.variants.first.id | plus: 0
                if item.variant_id == gb_promo_variant_chk
                  assign hide_remove_button = true
                endif

                # Flag for promo gifts (BXGY + GB promo) ‚Äî hides quantity + price block
                assign is_promo_gift = false
                if item.variant_id == bxgy_gift_1_id or item.variant_id == bxgy_gift_2_id or item.variant_id == gb_promo_variant_chk
                  assign is_promo_gift = true
                endif
              -%}
              <cart-remove-button
                id="Remove-{{ item.index | plus: 1 }}"
                data-index="{{ item.index | plus: 1 }}"
                {% if hide_remove_button %}
                  class="hidden"
                {% endif %}
              >
                <a
                  href="{{ shop.url }}{{ item.url_to_remove }}"
                  class="delete-product"
                  aria-label="{{ 'sections.cart.remove_title' | t: title: item.title }}"
                  data-no-instant
                >
                  {% render 'icon', icon: 'close-alt' %}
                </a>
              </cart-remove-button>
              <div class="product-container{% unless item.image %} no-image{% endunless %}">
                {% if item.image %}
                  <div>
                    <a href="{{ shop.url }}{{ item.url }}" class="product-image media-wrapper media-wrapper--small">
                      <div
                        class="media media--adapt"
                        style="--image-ratio-percent: {{ 1 | divided_by: item.image.aspect_ratio | times: 100 }}%;"
                      >
                        <img
                          srcset="{{ item.image | image_url: width: 70 }} 1x, {{ item.image | image_url: width: 140 }} 2x"
                          src="{{ item.image | image_url: width: 70 }}"
                          alt="{{ item.image.alt | escape | split: '#' | first }}"
                          width="70"
                          height="{{ 70 | divided_by: item.image.aspect_ratio | ceil }}"
                          loading="lazy"
                          is="lazy-image"
                        >
                      </div>
                    </a>
                  </div>
                {% endif %}
                <div class="product-description">
                  <div class="product-content">
                    <a href="{{ shop.url }}{{ item.url }}" class="link product-title">{{ item.product.title }}</a>
                  </div>

                  {%- if item.product.has_only_default_variant == false
                    or item.properties.size != 0
                    or item.selling_plan_allocation != null
                  -%}
                    {%- if item.product.has_only_default_variant == false or item.properties.size != 0 -%}
                      <dl>
                        {%- if item.product.has_only_default_variant == false -%}
                          {%- for option in item.options_with_values -%}
                            <div class="product-option">
                              <dt>{{ option.name }}:</dt>
                              <dd>{{ option.value }}</dd>
                            </div>
                          {%- endfor -%}
                        {%- endif -%}

                        {%- for property in item.properties -%}
                          {%- assign property_first_char = property.first | slice: 0 -%}
                          {%- if property.last != blank and property_first_char != '_' -%}
                            <div class="product-option">
                              <dt>{{ property.first }}:</dt>
                              <dd>
                                {%- if property.last contains '/uploads/' -%}
                                  <a href="{{ property.last }}" target="_blank">
                                    {{ property.last | split: '/' | last }}
                                  </a>
                                {%- else -%}
                                  {{ property.last }}
                                {%- endif -%}
                              </dd>
                            </div>
                          {%- endif -%}
                        {%- endfor -%}

                        {%- if item.variant.available and item.unit_price_measurement -%}
                          <div class="unit-price">
                            <span class="visually-hidden">{{ 'products.product.price.unit_price' | t }}</span>
                            <price-money
                              ><bdi>
                                {%- if settings.currency_code_enabled -%}
                                  {{- item.variant.unit_price | money_with_currency -}}
                                {%- else -%}
                                  {{- item.variant.unit_price | money -}}
                                {%- endif -%}
                              </bdi></price-money
                            >
                            <span aria-hidden="true">/</span>
                            <span class="visually-hidden"
                              >&nbsp;{{ 'accessibility.unit_price_separator' | t }}&nbsp;</span
                            >
                            {%- if item.variant.unit_price_measurement.reference_value != 1 -%}
                              {{- item.variant.unit_price_measurement.reference_value -}}
                            {%- endif -%}
                            {{ item.variant.unit_price_measurement.reference_unit }}
                          </div>
                        {%- endif -%}
                      </dl>
                    {%- endif -%}

                    {%- if item.selling_plan_allocation != null -%}
                      <div class="product-option">{{ item.selling_plan_allocation.selling_plan.name }}</div>
                    {%- endif -%}

                    <ul class="discounts list-unstyled" role="list" aria-label="{{ 'customer.order.discount' | t }}">
                      {%- for discount in item.discounts -%}
                        <li class="discounts__discount">
                          {%- render 'icon', icon: 'discount' -%}
                          {{ discount.title }}
                        </li>
                      {%- endfor -%}
                    </ul>
                  {%- endif -%}

                  {%- unless is_promo_gift -%}
                  <div class="product-quantity">
                    <dt>
                      {%- liquid
                        # Check if this is gift bundle (variant_id = 43694372257923)
                        assign is_gift_bundle = false
                        if item.variant_id == 43694372257923
                          assign is_gift_bundle = true
                        endif

                        # Check if this is a Buy X Get Y gift item
                        assign is_bxgy_gift = false
                        assign bxgy_gift_1_id = settings.buy_x_get_y_gift_variant_1 | plus: 0
                        assign bxgy_gift_2_id = settings.buy_x_get_y_gift_variant_2 | plus: 0
                        if item.variant_id == bxgy_gift_1_id or item.variant_id == bxgy_gift_2_id
                          assign is_bxgy_gift = true
                        endif

                        # Check if this is a GB Promo Gift item
                        assign gb_promo_variant_chk = settings.gb_promo_gift_product.variants.first.id | plus: 0
                        if item.variant_id == gb_promo_variant_chk
                          assign is_bxgy_gift = true
                        endif
                      -%}

                      {%- if gift_wrap_id == null or item.id != gift_wrap_id -%}
                        <label for="Quantity-{{ item.index | plus: 1 }}" class="visually-hidden">
                          {{- 'products.product.quantity.label' | t -}}
                        </label>
                        {%- if is_bxgy_gift -%}
                          {%- comment -%} Buy X Get Y gift - hide quantity controls {%- endcomment -%}
                          <quantity-input class="quantity">
                            <button class="quantity__button no-js-hidden visually-hidden" name="minus" type="button" disabled="disabled" style="display: none !important;">
                              <span class="visually-hidden">
                                {{- 'products.product.quantity.decrease' | t: product: item.product.title | escape -}}
                              </span>
                              {% render 'icon', icon: 'minus' %}
                            </button>
                            <input
                              class="quantity__input"
                              type="number"
                              name="updates[]"
                              value="{{ item.quantity }}"
                              min="0"
                              max="{{item.variant.inventory_quantity }}"
                              data-inventory-quantity="{{ item.variant.inventory_quantity }}"
                              aria-label="{{ 'products.product.quantity.input_label' | t: product: item.product.title | escape }}"
                              id="Quantity-{{ item.index | plus: 1 }}"
                              data-index="{{ item.index | plus: 1 }}"
                              readonly
                              disabled="disabled"
                            >
                            <button class="quantity__button no-js-hidden visually-hidden" name="plus" type="button" disabled="disabled" style="display: none !important;">
                              <span class="visually-hidden">
                                {{- 'products.product.quantity.increase' | t: product: item.product.title | escape -}}
                              </span>
                              {% render 'icon', icon: 'plus' %}
                            </button>
                          </quantity-input>
                        {%- else -%}
                          {%- comment -%} Regular item - normal quantity controls {%- endcomment -%}
                          <quantity-input class="quantity">
                            <button class="quantity__button no-js-hidden test" name="minus" type="button">
                              <span class="visually-hidden">
                                {{- 'products.product.quantity.decrease' | t: product: item.product.title | escape -}}
                              </span>
                              {% render 'icon', icon: 'minus' %}
                            </button>
                            <input
                              class="quantity__input d"
                              type="number"
                              name="updates[]"
                              value="{{ item.quantity }}"
                              min="0"
                              max="{{item.variant.inventory_quantity }}"
                              data-inventory-quantity="{{ item.variant.inventory_quantity }}"
                              aria-label="{{ 'products.product.quantity.input_label' | t: product: item.product.title | escape }}"
                              id="Quantity-{{ item.index | plus: 1 }}"
                              data-index="{{ item.index | plus: 1 }}"
                            >
                            <button class="quantity__button no-js-hidden test" name="plus" type="button">
                              <span class="visually-hidden">
                                {{- 'products.product.quantity.increase' | t: product: item.product.title | escape -}}
                              </span>
                              {% render 'icon', icon: 'plus' %}
                            </button>
                          </quantity-input>
                        {%- endif -%}

                        {%- comment -%} Max stock warning - only shows when limit reached {%- endcomment -%}
                        {%- assign variant_total = 0 -%}
                        {%- for cart_item in cart.items -%}
                          {%- if cart_item.variant_id == item.variant_id -%}
                            {%- assign variant_total = variant_total | plus: cart_item.quantity -%}
                          {%- endif -%}
                        {%- endfor -%}
                        <div
                          class="cart-item-warning"
                          data-line="{{ item.index | plus: 1 }}"
                          data-max="{{ item.variant.inventory_quantity }}"
                        >
                          Last {{ item.variant.inventory_quantity }} available
                          {%- if variant_total > item.quantity -%}
                            ({{ variant_total }} total in cart across multiple lines)
                          {%- endif -%}
                        </div>
                      {%- else -%}
                        <gift-quantity
                          class="quantity"
                          cart-items-size="{{ cart.items.size }}"
                          gift-wraps-in-cart="{{ gift_wraps_in_cart }}"
                          items-in-cart="{{ items_in_cart }}"
                        >
                          <label for="Quantity-{{ item.index | plus: 1 }}" class="visually-hidden">
                            {{- 'products.product.quantity.label' | t }}:</label
                          >
                          <button
                            class="quantity__button no-js-hidden visually-hidden"
                            name="minus"
                            type="button"
                            disabled="disabled"
                          >
                            <span class="visually-hidden">
                              {{- 'products.product.quantity.decrease' | t: product: item.product.title | escape -}}
                            </span>
                            {% render 'icon', icon: 'minus' %}
                          </button>
                          <input
                            class="quantity__input"
                            type="number"
                            name="updates[]"
                            value="{{ item.quantity }}"
                            min="0"
                            aria-label="{{ 'products.product.quantity.input_label' | t: product: item.product.title | escape }}"
                            id="Quantity-{{ item.index | plus: 1 }}"
                            data-index="{{ item.index | plus: 1 }}"
                            disabled="disabled"
                          >
                          <button
                            class="quantity__button no-js-hidden visually-hidden"
                            name="plus"
                            type="button"
                            disabled="disabled"
                          >
                            <span class="visually-hidden">
                              {{- 'products.product.quantity.increase' | t: product: item.product.title | escape -}}
                            </span>
                            {% render 'icon', icon: 'plus' %}
                          </button>
                        </gift-quantity>
                      {%- endif -%}
                    </dt>

                    {%- if is_gift_bundle -%}
                      {%- comment -%} Gift bundle - show discounted price with strikethrough {%- endcomment -%}
                      {%- if item.original_price != item.final_price -%}
                        <dl class="cart-item__discounted-prices">
                          <dt class="visually-hidden">
                            {{ 'products.product.price.regular_price' | t }}
                          </dt>
                          <dd class="price--on-sale">
                            <s class="price price-item--regular">
                              <price-money
                                ><bdi>{{ item.original_price | money }}</bdi></price-money
                              >
                            </s>
                          </dd>
                          <dt class="visually-hidden">
                            {{ 'products.product.price.sale_price' | t }}
                          </dt>
                          <dd class="price">
                            <price-money
                              ><bdi>{{ item.final_price | money }}</bdi></price-money
                            >
                          </dd>
                        </dl>
                      {%- else -%}
                        <dd class="price">
                          <price-money
                            ><bdi>{{ item.original_price | money }}</bdi></price-money
                          >
                        </dd>
                      {%- endif -%}
                    {%- else -%}
                      {%- if item.original_price != item.final_price -%}
                        <dl class="cart-item__discounted-prices">
                          <dt class="visually-hidden">
                            {{ 'products.product.price.regular_price' | t }}
                          </dt>
                          <dd class="price--on-sale">
                            <s class="price price-item--regular">
                              <price-money
                                ><bdi>{{ item.original_price | money }}</bdi></price-money
                              >
                            </s>
                          </dd>
                          <dt class="visually-hidden">
                            {{ 'products.product.price.sale_price' | t }}
                          </dt>
                          <dd class="price">
                            <price-money
                              ><bdi>{{ item.final_price | money }}</bdi></price-money
                            >
                          </dd>
                        </dl>
                      {%- else -%}
                        <dd class="price">
                          <price-money
                            ><bdi>{{ item.original_price | money }}</bdi></price-money
                          >
                        </dd>
                      {%- endif -%}
                    {%- endif -%}
                  </div>
                  {%- endunless -%}
                  <p class="cart-item__error form__message errors" id="Line-item-error-{{ item.index | plus: 1 }}">
                    <span class="cart-item__error-text"></span>
                  </p>
                </div>
              </div>
            </li>
          {%- endfor -%}
        </ul>
      </cart-items>
    </div>

    {%- assign animate_count = animate_count | plus: 1 -%}
    <div class="mini-cart__footer" data-animate data-animate-delay-{{ animate_count }}>
      {%- if gift_wrapping != null -%}
        <gift-wrapping
          class="gift-wrapping"
          data-gift-wrap-id="{{ gift_wrap_id }}"
          data-gift-wrapping="{{ cart.attributes.gift-wrapping | escape }}"
          cart-items-size="{{ cart.items.size }}"
          gift-wraps-in-cart="{{ gift_wraps_in_cart }}"
          items-in-cart="{{ items_in_cart }}"
        >
          <input
            id="gift-wrapping"
            type="checkbox"
            name="attributes[gift-wrapping]"
            value="yes"
            {% if cart.attributes['gift-wrapping'] %}
              checked="checked"
            {% endif %}
            class="visually-hidden"
          >
          <label for="gift-wrapping" class="gift-wrapping__label">
            {%- capture gift_price -%}<price-money class="price"><bdi>{{ gift_wrapping.object.price | money }}</bdi></price-money>{%- endcapture -%}
            <span class="gift-wrapping__text">{{ 'sections.cart.gift_wrapping_html' | t: price: gift_price }}</span>
            <div class="loading-overlay hidden">
              <div class="loading-overlay__spinner">
                {% render 'icon', icon: 'spinner' %}
              </div>
            </div>
            {% render 'icon', icon: 'checkmark', class: 'gift-wrapping__icon' %}
          </label>
        </gift-wrapping>
      {%- endif -%}

      {%- liquid
        # –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ —á–∏ —î –≥—ñ—Ñ—Ç-–±–∞–Ω–¥–ª –≤ –∫–æ—à–∏–∫—É
        assign gift_variant_id = 43694372257923
        assign gift_variant_id_string = '43694372257923'
        assign gift_in_cart = false
        assign non_gift_items_count = 0


        for item in cart.items
          if item.variant_id == gift_variant_id or item.variant_id == gift_variant_id_string
            assign gift_in_cart = true
          else
            assign non_gift_items_count = non_gift_items_count | plus: item.quantity
          endif
        endfor

    
        assign upsell_heading = settings.upsell_heading | default: 'Complete your routine'
      -%}

      <script>
        // –ü–µ—Ä–µ–¥–∞—Ç–∏ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—é –ø—Ä–æ –∫–æ—à–∏–∫ –≤ JavaScript –¥–ª—è mini-cart
        window.miniCartGiftInCart = {{ gift_in_cart | json }};
        window.miniCartNonGiftItemsCount = {{ non_gift_items_count | json }};
      </script>

      <style>
        li[data-handle='gift-bundle'] .cart-item__discounted-prices .price-item--regular {
          display: none !important;
        }

        .mini-cart__gift-section {
          margin: 20px 0 16px 0;
          padding: 0 20px;
        }

        .mini-cart__validation-section {
          margin: 16px 0;
          padding: 0 20px;
        }

        .gift-claim-container {
          background: linear-gradient(135deg, #f8f4ff 0%, #fff5f7 100%);
          border: 2px solid #e6cedf;
          border-radius: 12px;
          padding: 20px;
          display: flex;
          align-items: center;
          justify-content: space-between;
          gap: 16px;
          box-shadow: 0 2px 8px rgba(230, 206, 223, 0.15);
          transition: all 0.3s ease;
        }

        .gift-claim-container:hover {
          box-shadow: 0 4px 12px rgba(230, 206, 223, 0.25);
          transform: translateY(-1px);
        }

        .gift-claim-content {
          display: flex;
          align-items: center;
          gap: 14px;
          flex: 1;
        }

        .gift-icon {
          font-size: 32px;
          line-height: 1;
          animation: giftBounce 2s ease-in-out infinite;
        }

        .gift-icon img {
          width: 200px;
          height: auto;
        }

        @keyframes giftBounce {
          0%,
          100% {
            transform: translateY(0);
          }
          50% {
            transform: translateY(-4px);
          }
        }

        .gift-text {
          flex: 1;
        }

        .gift-title {
          margin: 0 0 4px 0;
          font-size: 16px;
          font-weight: 600;
          color: #2d2d2d;
          letter-spacing: 0.3px;
        }

        .gift-description {
          margin: 0;
          font-size: 13px;
          color: #666;
          line-height: 1.4;
        }

        .button--gift {
          background: #e6cedf;
          border: 2px solid #e6cedf;
          color: #2d2d2d;
          font-weight: 600;
          font-size: 13px;
          letter-spacing: 0.5px;
          padding: 12px 24px;
          border-radius: 25px;
          flex-shrink: 0;
          transition: all 0.3s ease;
          text-transform: uppercase;
          box-shadow: 0 2px 6px rgba(230, 206, 223, 0.3);
          display: flex;
          align-items: center;
          justify-content: center;
          min-width: 120px;
        }

        .button--gift:hover {
          background: #d4b5c7;
          border-color: #d4b5c7;
          transform: scale(1.05);
          box-shadow: 0 4px 10px rgba(230, 206, 223, 0.4);
        }

        .button--gift:active {
          transform: scale(0.98);
        }

        .button--gift.loading {
          pointer-events: none;
          color: transparent;
          position: relative;
        }

        .button--gift.loading::after {
          content: '';
          position: absolute;
          top: 50%;
          left: 50%;
          width: 14px;
          height: 14px;
          margin: -7px 0 0 -7px;
          border: 2px solid #2d2d2d;
          border-right-color: transparent;
          border-radius: 50%;
          animation: gift-btn-spin 0.6s linear infinite;
        }

        @keyframes gift-btn-spin {
          to { transform: rotate(360deg); }
        }

        @keyframes dash {
          0% {
            stroke-dasharray: 1, 200;
            stroke-dashoffset: 0;
          }
          50% {
            stroke-dasharray: 100, 200;
            stroke-dashoffset: -15;
          }
          100% {
            stroke-dasharray: 100, 200;
            stroke-dashoffset: -125;
          }
        }

        @media screen and (max-width: 420px) {
          .gift-claim-container {
            padding: 16px;
            gap: 12px;
          }

          .gift-icon {
            font-size: 28px;
          }

          .gift-title {
            font-size: 14px;
          }

          .gift-description {
            font-size: 12px;
          }

          .button--gift {
            font-size: 11px;
            padding: 10px 18px;
          }
        }

        .gift-bundle-offer {
          display: flex;
          align-items: center;
          justify-content: space-between;
          background: #f8f9fa;
          border: 1px solid #e9ecef;
          border-radius: 4px;
          padding: 12px 16px;
          margin-bottom: 12px;
        }

        .gift-bundle-content {
          display: flex;
          align-items: center;
          flex: 1;
        }

        .gift-bundle-icon {
          display: none;
        }

        .gift-bundle-text {
          flex: 1;
        }

        .gift-bundle-title {
          font-size: 14px;
          font-weight: 500;
          margin: 0 0 4px 0;
          color: #212529;
        }

        .gift-bundle-description {
          font-size: 12px;
          margin: 0;
          color: #6c757d;
          line-height: 1.3;
        }

        .gift-bundle-add,
        .gift-bundle-remove {
          flex-shrink: 0;
          min-width: auto;
          padding: 8px 12px;
          font-size: 12px;
          margin-left: 12px;
        }

        .gift-bundle-add {
          background: #28a745;
          border-color: #28a745;
        }

        .gift-bundle-add:hover {
          background: #218838;
          border-color: #218838;
        }

        .gift-bundle-add:disabled {
          background: #6c757d;
          border-color: #6c757d;
          cursor: not-allowed;
        }

        .gift-bundle-remove {
          background: transparent;
          color: #dc3545;
          border-color: #dc3545;
        }

        .gift-bundle-remove:hover {
          background: #dc3545;
          color: white;
        }

        .gift-validation-message {
          background: #f8f9fa;
          border: 1px solid #e9ecef;
          border-radius: 4px;
          padding: 12px 16px;
          margin-top: 12px;
        }

        .validation-content {
          display: flex;
          align-items: center;
          justify-content: center;
        }

        .validation-text p {
          margin: 0;
          font-size: 12px;
          color: #6c757d;
          line-height: 1.3;
          text-align: center;
        }

        @media screen and (max-width: 749px) {
          .mini-cart__gift-section {
            padding: 0 16px;
          }

          .gift-bundle-offer {
            padding: 12px;
          }

          .gift-bundle-icon {
            font-size: 24px;
            margin-right: 8px;
          }

          .gift-bundle-title {
            font-size: 13px;
          }

          .gift-bundle-description {
            font-size: 11px;
          }

          .gift-bundle-add,
          .gift-bundle-remove {
            padding: 6px 8px;
            font-size: 11px;
          }
        }

        .button--disabled {
          cursor: not-allowed !important;
          opacity: 1 !important;
        }

        .button--disabled:hover {
          opacity: 1 !important;
        }
      </style>

      {% assign available_upsell_products = 0 %}
      {% for product in collections['upsell-products'].products %}
        {% assign in_cart = false %}
        {% for item in cart.items %}
          {% if item.product_id == product.id %}
            {% assign in_cart = true %}
            {% break %}
          {% endif %}
        {% endfor %}
        {% unless in_cart %}
          {% assign available_upsell_products = available_upsell_products | plus: 1 %}
        {% endunless %}
      {% endfor %}

      {% if available_upsell_products > 0 %}
        <div class="mini-cart__upsell" data-animate data-animate-delay-{{ animate_count | plus: 1 }}>
          <h3 class="mini-cart__upsell-heading">{{ upsell_heading }}</h3>
          {% render 'changable-upsell', cart: cart %}
          <div class="custom-upsell-slider">
            <div class="slider-wrapper">
              {% for product in collections['upsell-products'].products %}
                {% assign in_cart = false %}
                {% for item in cart.items %}
                  {% if item.product_id == product.id %}
                    {% assign in_cart = true %}
                    {% break %}
                  {% endif %}
                {% endfor %}
                {% unless in_cart %}
                  <div class="slider-slide">
                    <div
                      class="mini-cart__upsell-item"
                      data-product-id="{{ product.id }}"
                      data-product-handle="{{ product.handle }}"
                    >
                      <div class="mini-cart__upsell-product">
                        <a href="{{ shop.url }}{{ product.url }}" class="mini-cart__upsell-image">
                          <img
                            src="{{ product.featured_image | image_url: width: 100 }}"
                            alt="{{ product.featured_image.alt | escape }}"
                            width="40"
                            height="40"
                            loading="lazy"
                          >
                        </a>

                        <div class="mini-cart__upsell-details">
                          <a href="{{ shop.url }}{{ product.url }}" class="mini-cart__upsell-title">
                            {{ product.title | upcase }}
                          </a>

                          {% unless product.has_only_default_variant %}
                            <div class="mini-cart__upsell-variants">
                              <div class="select mini-cart__upsell-select">
                                <select
                                  class="upsell-variant-selector select__select"
                                  data-product-id="{{ product.id }}"
                                >
                                  {% for variant in product.variants %}
                                    <option
                                      value="{{ variant.id }}"
                                      {% if forloop.first %}
                                        selected
                                      {% endif %}
                                    >
                                      {{ variant.title }}
                                    </option>
                                  {% endfor %}
                                </select>
                                {% render 'icon', icon: 'caret' %}
                              </div>
                            </div>
                          {% else %}
                            <input
                              type="hidden"
                              class="selected-variant-id"
                              value="{{ product.variants.first.id }}"
                            >
                          {% endunless %}
                        </div>

                        <add-to-cart
                          class="mini-cart__upsell-add-button"
                          data-product-id="{{ product.id }}"
                          {% if product.has_only_default_variant %}
                            data-variant-id="{{ product.variants.first.id }}"
                          {% endif %}
                        >
                          ADD ¬∑ {{ product.price | money_without_trailing_zeros }}
                        </add-to-cart>
                      </div>
                    </div>
                  </div>
                {% endunless %}
              {% endfor %}
            </div>

            <div class="slider-pagination"></div>
          </div>
        </div>
      {% endif %}
      <style>
        .custom-upsell-slider {
          position: relative;
          margin: 0 -5px;
          overflow: hidden;
          touch-action: pan-x;
          user-select: none;
        }

        .slider-wrapper {
          position: relative;
          width: 100%;
          height: auto;
          min-height: 40px;
          overflow: hidden;
          cursor: grab;
          transition: height 0.5s cubic-bezier(0.23, 1, 0.32, 1);
        }

        .slider-wrapper:active {
          cursor: grabbing;
        }

        .slider-slide {
          position: absolute;
          top: 0;
          left: 0;
          width: 100%;
          height: auto;
          padding: 0 5px;
          box-sizing: border-box;
          transition: transform 0.5s cubic-bezier(0.23, 1, 0.32, 1);
          will-change: transform;
          opacity: 1;
          visibility: visible;
          backface-visibility: hidden;
          transform-style: preserve-3d;
        }

        .slider-slide.slider-slide-initialized {
          display: block;
        }

        .slider-pagination {
          position: relative;
          text-align: center;
          display: block;
          visibility: visible;
          z-index: 10;
        }

        .slider-bullet {
          display: inline-block;
          width: 10px;
          height: 10px;
          background: #999;
          border-radius: 50%;
          margin: 0 6px;
          cursor: pointer;
          transition: all 0.5s cubic-bezier(0.23, 1, 0.32, 1);
          border: none;
          outline: none;
          position: relative;
        }

        .slider-bullet.active {
          background: #333;
          transform: scale(1.3);
        }

        .slider-bullet:hover {
          background: #666;
          transform: scale(1.1);
        }

        .mini-cart__upsell-item {
          width: 100%;
          height: 100%;
        }

        @media (max-width: 768px) {
          .custom-upsell-slider {
            margin: 0 -3px;
          }

          .slider-slide {
            padding: 0 3px;
          }

          .slider-bullet {
            width: 8px;
            height: 8px;
            margin: 0 4px;
          }
        }

        .cart-drawer [data-animate-delay-3],
        .cart-drawer [data-animate-delay-2],
        .cart-drawer [data-animate-delay-4] {
          transition-delay: 0s !important;
        }
        .mini-cart__footer {
          padding-top: 0;
        }

        .mini-cart__upsell {
          padding-top: 0 !important;
          border-radius: 4px;
        }

        .mini-cart__upsell-heading {
          margin-top: 8px !important;
          font-size: 14px;
          font-weight: 400;
          margin-bottom: 8px;
          text-align: center;
          color: #444;
        }

        .mini-cart__upsell-item {
          background: #fff;
          border-radius: 3px;
          padding: 6px 5px;
        }

        .mini-cart__upsell-product {
          display: flex;
          align-items: center;
          justify-content: space-between;
        }

        .mini-cart__upsell-image {
          width: 40px;
          height: 40px;
          flex-shrink: 0;
          margin-right: 6px;
          overflow: hidden;
          border-radius: 3px;
        }

        .mini-cart__upsell-image img {
          width: 100%;
          height: 100%;
          object-fit: cover;
        }

        .mini-cart__upsell-details {
          flex: 1 1 0;
          min-width: 0;
          padding-right: 5px;
        }

        .mini-cart__upsell-title {
          display: inline-block;
          max-width: 150px;
          font-size: 11px;
          font-weight: 600;
          text-transform: uppercase;
          overflow: hidden;
          text-overflow: ellipsis;
          white-space: nowrap;
          word-break: break-all;
          color: inherit;
          text-decoration: none;
        }

        .mini-cart__upsell-variants {
          margin-top: 2px;
        }

        .mini-cart__upsell-select {
          margin-top: 2px;
        }

        .mini-cart__upsell-select select {
          font-size: 10px;
          padding: 1px 5px;
          height: auto;
        }

        .mini-cart__upsell-add-button {
          font-size: 10px;
          padding: 5px 10px;
          background: #6c6c6c;
          color: #fff;
          border: none;
          border-radius: 20px;
          cursor: pointer;
          transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
          flex-shrink: 0;
          position: relative;
          overflow: hidden;
          box-shadow: 0 2px 4px rgba(108, 108, 108, 0.2);
        }

        .mini-cart__upsell-add-button::before {
          content: '';
          position: absolute;
          top: 0;
          left: -100%;
          width: 100%;
          height: 100%;
          background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.6), transparent);
          transition: left 0.4s ease-out;
        }

        .mini-cart__upsell-add-button:hover {
          background: #555;
          box-shadow: 0 4px 12px rgba(85, 85, 85, 0.3);
          color: #fff;
        }

        .mini-cart__upsell-add-button:hover::before {
          left: 100%;
        }

        .mini-cart__upsell-add-button.added {
          background: #17bf17;
        }

        /* Improved mobile responsiveness for screens below 420px */
        @media screen and (max-width: 420px) {
          .mini-cart__upsell-product {
            flex-wrap: wrap;
          }

          .mini-cart__upsell-image {
            width: 35px;
            height: 35px;
          }

          .mini-cart__upsell-details {
            width: calc(100% - 115px);
          }

          .mini-cart__upsell-title {
            max-width: 100%;
            font-size: 10px;
          }

          .mini-cart__upsell-add-button {
            font-size: 9px;
            padding: 4px 8px;
            margin-left: auto;
          }

          .mini-cart__upsell-select select {
            font-size: 9px;
            padding: 0 3px;
          }

          /* For very small screens */
          @media screen and (max-width: 340px) {
            .mini-cart__upsell-image {
              width: 30px;
              height: 30px;
            }

            .mini-cart__upsell-details {
              width: calc(100% - 100px);
            }

            .mini-cart__upsell-add-button {
              font-size: 8px;
              padding: 3px 6px;
            }
          }
        }
        /* –ó–∞–º–µ–Ω–∏—Ç—å .clicked –Ω–∞ .added (–∏–ª–∏ –¥–æ–±–∞–≤–∏—Ç—å –æ–±–∞) */
        add-to-cart.mini-cart__upsell-add-button.added::after {
          opacity: 1;
        }
        /* (–µ—Å–ª–∏ —Ö–æ—Ç–∏—Ç–µ –æ—Å—Ç–∞–≤–∏—Ç—å .clicked, –º–æ–∂–Ω–æ –æ–±—ä–µ–¥–∏–Ω–∏—Ç—å) */
        add-to-cart.mini-cart__upsell-add-button.added::after,
        add-to-cart.mini-cart__upsell-add-button.clicked::after {
          opacity: 1;
        }

        .button--secondary {
          position: relative;
          overflow: hidden;
        }

        .button--secondary::before {
          content: '';
          position: absolute;
          top: 0;
          left: -100%;
          width: 100%;
          height: 100%;
          background: linear-gradient(90deg, transparent, rgba(128, 128, 128, 0.4), transparent);
          opacity: 0;
          transition: none;
        }

        .button--secondary:hover::before {
          opacity: 1;
          animation: shine 0.6s ease-out;
        }

        @keyframes shine {
          0% {
            left: -100%;
          }
          100% {
            left: 100%;
          }
        }
        .button--secondary:hover::before {
          left: 100%;
        }
        .mini-cart__actions {
          display: none;
        }
        .subtotal {
          padding-top: 20px;
          border-top: 1px solid #d2d5d9;
        }
      </style>

      {%- if settings.show_cart_note
        or settings.show_shipping_calculator
        or gift_wrapping != null
        and cart.attributes['gift-wrapping']
      -%}
        <div class="mini-cart__actions">
          {%- if gift_wrapping != null and cart.attributes['gift-wrapping'] -%}
            <details class="mini-cart__action disclosure-has-popup">
              <summary>
                <span>
                  {% render 'icon', icon: 'gift' %}
                  {{ 'general.cart.gift_note.title' | t }}
                </span>
              </summary>
              <div>
                <button type="button" class="close" onclick="this.closest('details').querySelector('summary').click()">
                  {% render 'icon', icon: 'close' %}
                </button>
                <label for="Gift-note">{{ 'general.cart.gift_note.caption' | t }}</label>
                <gift-note class="mini-cart__note">
                  <div class="field">
                    <textarea
                      class="text-area text-area--resize-vertical field__input"
                      name="attributes[gift-note]"
                      id="Gift-note"
                    >{{ cart.attributes.gift-note }}</textarea>
                  </div>
                  <div>
                    <button
                      class="button button--full-width"
                      type="button"
                      onclick="this.closest('details').querySelector('summary').click()"
                    >
                      {{ 'general.cart.gift_note.button' | t }}
                    </button>
                  </div>
                </gift-note>
              </div>
            </details>
          {%- endif -%}

          {%- if settings.show_cart_note -%}
            <details class="mini-cart__action disclosure-has-popup">
              <summary>
                <span>
                  {% render 'icon', icon: 'pen' %}
                  {{ 'general.cart.note.title' | t }}
                </span>
              </summary>
              <div>
                <button type="button" class="close" onclick="this.closest('details').querySelector('summary').click()">
                  {% render 'icon', icon: 'close' %}
                </button>
                <label for="Cart-note">{{ 'general.cart.note.caption' | t }}</label>
                <cart-note class="mini-cart__note">
                  <div class="field">
                    <textarea
                      class="text-area text-area--resize-vertical field__input"
                      name="note"
                      id="Cart-note"
                    >{{ cart.note }}</textarea>
                  </div>
                  <div>
                    <button
                      class="button button--full-width"
                      type="button"
                      onclick="this.closest('details').querySelector('summary').click()"
                    >
                      {{ 'general.cart.note.button' | t }}
                    </button>
                  </div>
                </cart-note>
              </div>
            </details>
          {%- endif -%}

          {%- if settings.show_shipping_calculator -%}
            <details class="mini-cart__action disclosure-has-popup">
              <summary>
                <span>
                  {% render 'icon', icon: 'truck' %}
                  {{ 'general.cart.shipping_calculator.title' | t }}
                </span>
              </summary>
              <div>
                <button type="button" class="close" onclick="this.closest('details').querySelector('summary').click()">
                  {% render 'icon', icon: 'close' %}
                </button>
                <label for="ShippingCalculatorCountry">
                  {{ 'general.cart.shipping_calculator.caption' | t }}
                  <span class="mini-cart__question">
                    {% render 'icon', icon: 'question' %}
                    <span class="mini-cart__tooltip">{{ 'general.cart.shipping_calculator.tooltip' | t }}</span>
                  </span>
                </label>
                <shipping-calculator class="shipping__calculator">
                  <form-state>
                    <div class="field">
                      <div class="select">
                        <select
                          id="ShippingCalculatorCountry"
                          class="select__select required"
                          data-default="{% if shop.customer_accounts_enabled and customer %}{{ customer.default_address.country }}{% elsif settings.shipping_calculator_default_country != '' %}{{ settings.shipping_calculator_default_country }}{% endif %}"
                          autocomplete="country"
                          data-empty="---"
                        >
                          {{ all_country_option_tags }}
                        </select>
                        {% render 'icon', icon: 'caret' %}
                      </div>
                      <label class="visually-hidden" for="ShippingCalculatorCountry">
                        {{- 'customer.addresses.country' | t -}}
                      </label>
                    </div>
                    <div class="field" id="ShippingCalculatorProvinceContainer" style="display: none">
                      <div class="select">
                        <select
                          id="ShippingCalculatorProvince"
                          class="select__select"
                          data-default="{% if shop.customer_accounts_enabled and customer and customer.default_address.province != '' %}{{ customer.default_address.province }}{% endif %}"
                          autocomplete="address-level1"
                        ></select>
                        {% render 'icon', icon: 'caret' %}
                      </div>
                      <label class="visually-hidden" for="ShippingCalculatorProvince">
                        {{- 'customer.addresses.province' | t -}}
                      </label>
                    </div>
                    <div class="field">
                      <input
                        id="ShippingCalculatorZip"
                        class="field__input required"
                        type="text"
                        {% if shop.customer_accounts_enabled and customer %}
                          value="{{ customer.default_address.zip }}"
                        {% endif %}
                        autocapitalize="characters"
                        autocomplete="postal-code"
                        placeholder="{{ 'customer.addresses.zip' | t }}"
                      >
                      <label class="visually-hidden" for="ShippingCalculatorZip">
                        {{- 'customer.addresses.zip' | t -}}
                      </label>
                    </div>
                    <div>
                      <button class="button button--full-width" type="button">
                        {{ 'general.cart.shipping_calculator.button' | t }}
                      </button>
                    </div>
                    <div class="field form__message errors hidden" id="ShippingCalculatorErrors">
                      {% render 'icon', icon: 'error' %}
                      <div class="errors"></div>
                    </div>
                    <div class="field form__message hidden" id="ShippingCalculatorSuccess"></div>
                  </form-state>
                </shipping-calculator>
              </div>
            </details>
          {%- endif -%}
        </div>
      {%- endif -%}

      {%- if settings.show_discount_input -%}
        <discount-code
          class="cart__discount cart__discount--prominent field"
          style="margin-top: 15px; margin-bottom: 15px;"
        >
          <div class="cart__discount-wrapper" style="display: flex; gap: 10px;">
            <input
              type="text"
              name="discount"
              form="cart"
              class="field__input"
              placeholder="{{ 'sections.cart.discount_placeholder' | t }}"
              id="discount-code-input-drawer"
              style="flex: 1;"
            >
            <button type="button" class="promo-code-apply" id="discount-apply-btn-drawer">{{ 'sections.cart.apply' | t | default: 'Apply' }}</button>
          </div>
        </discount-code>
      {%- endif -%}

      {%- unless settings.disable_view_cart -%}
        <div class="subtotal">
          <div class="label h3">{{ 'sections.cart.subtotal' | t }}</div>
          <div class="value price" id="mini-cart-subtotal">{{ cart.total_price | money_with_currency }}</div>
        </div>
      {%- endunless -%}

      <div class="taxes-discounts">
        {%- if cart.cart_level_discount_applications.size > 0 -%}
          <ul class="discounts list-unstyled" role="list" aria-label="{{ 'customer.order.discount' | t }}">
            {%- for discount in cart.cart_level_discount_applications -%}
              <li class="discounts__discount discounts__discount--end">
                {% render 'icon', icon: 'discount' %}
                {{ discount.title }}
                (&#8211;{{ discount.total_allocated_amount | money }})
              </li>
            {%- endfor -%}
          </ul>
        {%- endif -%}
        {%- render 'tax-note' -%}
      </div>

      <div class="button-container">
        <button
          class="button"
          name="checkout"
          type="submit"
          data-checkout-button
        >
          {{ 'sections.cart.checkout' | t }}
          {%- if settings.disable_view_cart -%}
            <span class="price" id="mini-cart-subtotal">{{ cart.total_price | money_with_currency }}</span>
          {%- endif -%}
        </button>
        {%- unless settings.disable_view_cart -%}
          <a class="button button--secondary" href="{{ shop.url }}{{ routes.cart_url }}">{{ 'general.cart.view' | t }}</a>
        {%- endunless -%}
      </div>

      <style>
        .button--disabled {
          cursor: not-allowed !important;
          opacity: 1 !important;
        }

        .button--disabled:hover {
          opacity: 1 !important;
        }
      </style>
    </div>
  </div>
</form>
<script>
  window.dataLayer = window.dataLayer || [];
  window.dataLayer.push({
    event: 'view_cart',
    ecommerce: {
      items: [
        {% for item in cart.items %}
        {
          item_name: '{{ item.product.title | escape }}',
          item_id: '{{ item.variant.id }}',
          price: '{{ item.price | money_without_currency | remove: "," }}',
          currency: '{{ cart.currency.iso_code }}',
          item_brand: '{{ item.product.vendor | escape }}',
          item_category: '{{ item.product.type | escape }}',
          item_variant: '{{ item.variant.title | escape }}',
          quantity: {{ item.quantity }}
        }{% unless forloop.last %},{% endunless %}
        {% endfor %}
      ]
    }
  });
</script>

<script>
  if (window.initAfterAjax) {
    window.initAfterAjax();
  } else {
    document.addEventListener('DOMContentLoaded', function () {
      setTimeout(function () {
        if (window.initAfterAjax) {
          window.initAfterAjax();
        }
      }, 100);
    });
  }
</script>
