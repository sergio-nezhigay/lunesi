{% comment %}
  Shopify Contact Form with File Upload and Base64 Encoding
  Place this in your contact page template or as a section
{% endcomment %}
{{ 'section-contact-form.css' | asset_url | stylesheet_tag }}
{{ 'custom-form.css' | asset_url | stylesheet_tag }}
{{ 'section-rich-text.css' | asset_url | stylesheet_tag }}
{% schema %}
{
  "name": "Custom Contact Form",
  "settings": [
    {
      "type": "richtext",
      "id": "rich_text",
      "label": "Rich text",
      "default": "<h2>Contact Us</h2><p>Feel free to reach out to us at any time. We're here to help with orders, product questions, and any feedback you may have.<br></p><p>Our customer service team can assist by email Monday through Friday, from 9am to 6pm (excluding holidays). We'll aim to get back to you within 2 business days.</p><p>*indicates a required field</p>"
    },
    {
      "type": "range",
      "id": "padding_top",
      "label": "Section padding top (px)",
      "min": 0,
      "max": 100,
      "step": 4,
      "default": 16
    },
    {
      "type": "range",
      "id": "padding_bottom",
      "label": "Section padding bottom (px)",
      "min": 0,
      "max": 100,
      "step": 4,
      "default": 16
    }
  ],
  "presets": [
    {
      "name": "Custom Contact Form"
    }
  ]
}
{% endschema %}

<div
  class="contact-form-wrapper page-width"
  style="padding-top: {{ section.settings.padding_top | default: 16 }}px; padding-bottom: {{ section.settings.padding_bottom | default: 16 }}px;"
>
  <div class="rich-text">
    <div class="rich-text__blocks left mobile-left">
      <use-animate animate="">
        <div class="rich-text__text typeset2 rte">
          {{ section.settings.rich_text }}
        </div>
      </use-animate>
    </div>
  </div>
  {% form 'contact', id: 'contact-form', class: 'contact-form' %}
    {% if form.errors %}
      <div class="error-message">
        {{ form.errors | default_errors }}
      </div>
    {% endif %}
    {% if form.posted_successfully? %}
      <div class="success-message">
        <p>Thank you for contacting us! We'll get back to you soon.</p>
      </div>
    {% endif %}

    <div class="form-group">
      <input
        type="text"
        id="contact-name"
        name="contact[name]"
        class="form-input"
        value="{{ form.name }}"
        required
        placeholder="First and Last Name*"
      >
    </div>

    <div class="form-group">
      <input
        type="email"
        id="contact-email"
        name="contact[email]"
        class="form-input"
        value="{{ form.email }}"
        required
        placeholder="Email*"
      >
    </div>

    <div class="form-group">
      <select id="contact-reason" name="contact[reason]" class="form-select" required>
        <option value="">Contact Reason*</option>
        <option
          value="Order status"
          {% if form.reason == 'Order status' %}
            selected
          {% endif %}
        >
          Order status
        </option>
        <option
          value="Cancel or modify an order"
          {% if form.reason == 'Cancel or modify an order' %}
            selected
          {% endif %}
        >
          Cancel or modify an order
        </option>
        <option
          value="My order is missing"
          {% if form.reason == 'My order is missing' %}
            selected
          {% endif %}
        >
          My order is missing
        </option>
        <option
          value="My order arrived damaged"
          {% if form.reason == 'My order arrived damaged' %}
            selected
          {% endif %}
        >
          My order arrived damaged
        </option>
        <option
          value="Issue with my product"
          {% if form.reason == 'Issue with my product' %}
            selected
          {% endif %}
        >
          Issue with my product
        </option>
        <option
          value="Shipping questions"
          {% if form.reason == 'Shipping questions' %}
            selected
          {% endif %}
        >
          Shipping questions
        </option>
        <option
          value="Product questions"
          {% if form.reason == 'Product questions' %}
            selected
          {% endif %}
        >
          Product questions
        </option>
        <option
          value="Partnerships / collaboration"
          {% if form.reason == 'Partnerships / collaboration' %}
            selected
          {% endif %}
        >
          Partnerships / collaboration
        </option>
        <option
          value="Other / general inquiry"
          {% if form.reason == 'Other / general inquiry' %}
            selected
          {% endif %}
        >
          Other / general inquiry
        </option>
      </select>
      <span class="form-select-arrow">
        <svg
          width="18"
          height="18"
          viewBox="0 0 20 20"
          fill="none"
          style="display:block;"
          xmlns="http://www.w3.org/2000/svg"
        >
          <path d="M6 8L10 12L14 8" stroke="#757575" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </span>
    </div>

    <!-- Conditional Order Number Field -->
    <div class="form-group" id="order-number-group" style="display: none;">
      <input
        type="text"
        id="contact-order-number"
        name="contact[order_number]"
        class="form-input"
        value="{{ form.order_number }}"
        placeholder="Order Number*"
      >
      <div id="cancel-modify-notice" class="order-notice" style="display: none;">
        We'll make every effort to accommodate your request during business hours, but please note that once an order is
        placed, we cannot guarantee any changes can be made.
      </div>
    </div>

    <!-- Conditional Items with Issues Field -->
    <div class="form-group" id="items-issues-group" style="display: none;">
      <input
        type="text"
        id="contact-items-issues"
        name="contact[items_issues]"
        class="form-input"
        value="{{ form.items_issues }}"
        placeholder="Item(s) with issues"
      >
    </div>

    <div class="form-group">
      <input
        type="text"
        id="contact-topic"
        name="contact[topic]"
        class="form-input"
        value="{{ form.topic }}"
        required
        placeholder="Topic*"
      >
    </div>

    <div class="form-group">
      <textarea
        id="contact-body"
        name="contact[body]"
        class="form-textarea"
        required
        placeholder="Tell us the details.*"
      >{{ form.body }}</textarea>
    </div>

    <div class="form-group file-upload-group">
      <div class="file-size-info">(Optional: 5 files max, images will be automatically compressed)</div>
      <div class="file-upload-area" id="file-upload-area">
        <div class="file-upload-text">
          <div class="file-upload-icon">
            <svg xmlns="http://www.w3.org/2000/svg" x="0px" y="0px" width="50" height="50" viewBox="0 0 50 50">
              <path d="M 7 2 L 7 48 L 43 48 L 43 15.414063 L 29.410156 2 Z M 9 4 L 28 4 L 28 17 L 41 17 L 41 46 L 9 46 Z M 30 5.390625 L 39.734375 15 L 30 15 Z M 33.5 21.332031 C 32.457031 21.335938 31.609375 22.15625 31.609375 23.167969 C 31.613281 24.179688 32.457031 25 33.5 25 C 34.542969 25 35.386719 24.179688 35.390625 23.167969 C 35.390625 22.15625 34.542969 21.335938 33.5 21.332031 Z M 21.167969 24 C 20.835938 23.988281 20.519531 24.136719 20.324219 24.40625 L 12.863281 34.488281 C 12.640625 34.792969 12.605469 35.195313 12.773438 35.53125 C 12.945313 35.871094 13.289063 36.082031 13.667969 36.082031 L 28.425781 36.082031 C 28.449219 36.082031 28.472656 36.082031 28.496094 36.082031 C 28.5 36.082031 28.5 36.082031 28.503906 36.082031 L 35.015625 36 C 35.398438 35.996094 35.742188 35.769531 35.90625 35.421875 C 36.066406 35.074219 36.015625 34.667969 35.777344 34.371094 L 29.269531 26.386719 C 29.078125 26.148438 28.785156 26.011719 28.480469 26.015625 C 28.164063 26.023438 27.871094 26.175781 27.6875 26.429688 L 25.554688 29.363281 L 21.9375 24.410156 C 21.753906 24.164063 21.472656 24.011719 21.167969 24 Z M 21.125 26.6875 L 24.753906 31.660156 C 24.757813 31.667969 24.761719 31.671875 24.765625 31.675781 L 26.523438 34.082031 L 15.652344 34.082031 Z M 28.539063 28.65625 L 32.917969 34.027344 L 29 34.078125 L 26.796875 31.0625 Z"></path>
            </svg>
          </div>
          <span>Drag or paste image here</span>
        </div>
        <button type="button" class="file-upload-button" id="file-select-btn">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 50 50" class="file-upload-icon">
            <path d="M 7 2 L 7 48 L 43 48 L 43 15.414063 L 29.410156 2 Z M 9 4 L 28 4 L 28 17 L 41 17 L 41 46 L 9 46 Z M 30 5.390625 L 39.734375 15 L 30 15 Z M 33.5 21.332031 C 32.457031 21.335938 31.609375 22.15625 31.609375 23.167969 C 31.613281 24.179688 32.457031 25 33.5 25 C 34.542969 25 35.386719 24.179688 35.390625 23.167969 C 35.390625 22.15625 34.542969 21.335938 33.5 21.332031 Z M 21.167969 24 C 20.835938 23.988281 20.519531 24.136719 20.324219 24.40625 L 12.863281 34.488281 C 12.640625 34.792969 12.605469 35.195313 12.773438 35.53125 C 12.945313 35.871094 13.289063 36.082031 13.667969 36.082031 L 28.425781 36.082031 C 28.449219 36.082031 28.472656 36.082031 28.496094 36.082031 C 28.5 36.082031 28.5 36.082031 28.503906 36.082031 L 35.015625 36 C 35.398438 35.996094 35.742188 35.769531 35.90625 35.421875 C 36.066406 35.074219 36.015625 34.667969 35.777344 34.371094 L 29.269531 26.386719 C 29.078125 26.148438 28.785156 26.011719 28.480469 26.015625 C 28.164063 26.023438 27.871094 26.175781 27.6875 26.429688 L 25.554688 29.363281 L 21.9375 24.410156 C 21.753906 24.164063 21.472656 24.011719 21.167969 24 Z M 21.125 26.6875 L 24.753906 31.660156 C 24.757813 31.667969 24.761719 31.671875 24.765625 31.675781 L 26.523438 34.082031 L 15.652344 34.082031 Z M 28.539063 28.65625 L 32.917969 34.027344 L 29 34.078125 L 26.796875 31.0625 Z"></path>
          </svg>
          <span>Upload</span>
        </button>
        <input type="file" id="file-input" multiple accept="image/*,.pdf,.doc,.docx" class="visually-hidden">
      </div>
      <div class="file-list" id="file-list"></div>
    </div>

    <!-- Hidden field to store file information as text -->
    <input type="hidden" name="contact[file_info]" id="file-info-data">

    <button type="submit" class="submit-button" id="submit-btn">SUBMIT</button>
  {% endform %}
</div>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    const form = document.querySelector('#contact-form');
    if (!form) return;

    const email = form.querySelector('input[name="contact[email]"]');
    const errorIcon = '<span style="color:red;">âš </span>';
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]{2,}$/;

    form.addEventListener(
      'submit',
      function (e) {
        e.preventDefault();
        e.stopImmediatePropagation();

        form.querySelectorAll('.js-error').forEach((el) => el.remove());
        email.classList.remove('invalid');
        email.removeAttribute('aria-invalid');

        let hasError = false;

        if (!email.value.trim() || !emailRegex.test(email.value)) {
          showError(email, `${errorIcon} Email is invalid.`);
          hasError = true;
        }

        if (hasError) return;

        form.submit();
      },
      true
    );

    function showError(input, message) {
      const span = document.createElement('span');
      span.className = 'form__message errors js-error';
      span.innerHTML = message;

      input.classList.add('invalid');
      input.setAttribute('aria-invalid', 'true');

      input.closest('.form-group').insertAdjacentElement('beforeend', span);
    }
  });
</script>

<script>
{% comment %}
FORMDATA APPROACH - Replaces base64 encoding to fix CAPTCHA loops
Uses native browser FormData with multipart/form-data encoding
Eliminates 33% base64 overhead and prevents large POST payloads
{% endcomment %}
document.addEventListener('DOMContentLoaded', function() {
  // FEATURE FLAG: Toggle between FormData (new) and base64 (old) approach
  const USE_FORMDATA = true; // Set to false to revert to base64 method

  const fileInput = document.getElementById('file-input');
  const fileUploadArea = document.getElementById('file-upload-area');
  const fileSelectBtn = document.getElementById('file-select-btn');
  const fileList = document.getElementById('file-list');
  const fileInfoData = document.getElementById('file-info-data');
  const submitBtn = document.getElementById('submit-btn');
  const contactReason = document.getElementById('contact-reason');
  const orderNumberGroup = document.getElementById('order-number-group');
  const orderNumberInput = document.getElementById('contact-order-number');
  const cancelModifyNotice = document.getElementById('cancel-modify-notice');
  const itemsIssuesGroup = document.getElementById('items-issues-group');
  const itemsIssuesInput = document.getElementById('contact-items-issues');
  const form = document.getElementById('contact-form');

  let selectedFiles = [];
  let selectedBase64s = [];
  let compressedFiles = []; // Store compressed File objects for FormData
  const maxFiles = 5;
  const maxTotalSize = 50 * 1024 * 1024; // 50MB max total
  const maxFileSize = 50 * 1024 * 1024; // 50MB per file max (before compression)
  const maxCompressedSize = 150 * 1024; // 150KB target after compression
  const maxBase64TotalSize = 500 * 1024; // 500KB max for all base64 data combined
  let dragCounter = 0;

  // Order-related reasons that should show the order number field
  const orderRelatedReasons = [
    'Order status',
    'Cancel or modify an order',
    'My order is missing',
    'My order arrived damaged',
    'Issue with my product',
    'Shipping questions',
    'Other / general inquiry'
  ];

  // Handle contact reason change
  contactReason.addEventListener('change', function() {
    const selectedReason = this.value;

    if (orderRelatedReasons.includes(selectedReason)) {
      orderNumberGroup.style.display = 'block';
      orderNumberInput.required = true;

      if (selectedReason === 'Cancel or modify an order') {
        cancelModifyNotice.style.display = 'block';
      } else {
        cancelModifyNotice.style.display = 'none';
      }

      if (selectedReason === 'Issue with my product') {
        itemsIssuesGroup.style.display = 'block';
        itemsIssuesInput.required = true;
      } else {
        itemsIssuesGroup.style.display = 'none';
        itemsIssuesInput.required = false;
        itemsIssuesInput.value = '';
      }
    } else {
      orderNumberGroup.style.display = 'none';
      orderNumberInput.required = false;
      orderNumberInput.value = '';
      cancelModifyNotice.style.display = 'none';
      itemsIssuesGroup.style.display = 'none';
      itemsIssuesInput.required = false;
      itemsIssuesInput.value = '';
    }
  });

  // Check initial state on page load
  if (orderRelatedReasons.includes(contactReason.value)) {
    orderNumberGroup.style.display = 'block';
    orderNumberInput.required = true;

    if (contactReason.value === 'Cancel or modify an order') {
      cancelModifyNotice.style.display = 'block';
    }

    if (contactReason.value === 'Issue with my product') {
      itemsIssuesGroup.style.display = 'block';
      itemsIssuesInput.required = true;
    }
  }

  // NEW: FormData submission function (replaces base64 approach)
  async function submitWithFormData(e) {
    e.preventDefault();
    console.log('[FormData Debug] Starting FormData submission...');

    // Check required fields
    const requiredFields = form.querySelectorAll('[required]');
    let isValid = true;

    requiredFields.forEach(field => {
      if (!field.value.trim()) {
        isValid = false;
        field.style.borderColor = '#dc3545';
        field.addEventListener('input', function() {
          this.style.borderColor = '';
        }, { once: true });
      }
    });

    if (!isValid) {
      alert('Please fill in all required fields.');
      return false;
    }

    // Wait for files to be compressed
    if (selectedFiles.length > 0 && compressedFiles.length !== selectedFiles.length) {
      alert('Please wait for all files to finish uploading.');
      return false;
    }

    // Build FormData from form
    const formData = new FormData(form);

    // Remove the hidden file_info field (we'll add files directly)
    formData.delete('contact[file_info]');

    // Add compressed files as File objects (NOT base64)
    for (let i = 0; i < compressedFiles.length; i++) {
      const file = compressedFiles[i];
      formData.append(`contact[file_${i}]`, file, file.name);
      console.log(`[FormData Debug] Added file: contact[file_${i}] = ${file.name} (${formatFileSize(file.size)})`);
    }

    // Debug: Log all form data
    console.log('[FormData Debug] Total entries:', Array.from(formData.entries()).length);
    console.log('[FormData Debug] ========== FORM DATA CONTENTS ==========');
    for (let pair of formData.entries()) {
      if (pair[1] instanceof File) {
        console.log(`[FormData Debug] ðŸ“Ž FILE: ${pair[0]} = ${pair[1].name} (${formatFileSize(pair[1].size)}, ${pair[1].type})`);
      } else {
        console.log(`[FormData Debug] ðŸ“ FIELD: ${pair[0]} = ${pair[1]}`);
      }
    }
    console.log('[FormData Debug] ==========================================');

    // Submit via fetch
    try {
      submitBtn.disabled = true;
      submitBtn.textContent = 'Submitting...';

      console.log('[FormData Debug] Submitting to /contact...');
      const response = await fetch('/contact', {
        method: 'POST',
        body: formData
      });

      console.log('[FormData Debug] Response status:', response.status);
      const responseText = await response.text();

      // Check for CAPTCHA indicators
      if (responseText.includes('g-recaptcha') ||
          responseText.includes('recaptcha') ||
          response.status === 403) {
        console.error('[CAPTCHA DETECTED]');
        console.log('Response HTML length:', responseText.length);
        console.log('Response contains reCAPTCHA:', responseText.includes('recaptcha'));
        alert('CAPTCHA detected! File size may be too large. Try smaller files or fewer files.');
        submitBtn.disabled = false;
        submitBtn.textContent = 'SUBMIT';
        return;
      }

      // Check for success
      if (response.ok || response.status === 302) {
        console.log('[SUCCESS] Form submitted without CAPTCHA!');
        console.log('[SUCCESS] Response status:', response.status);
        alert('Form submitted successfully!');
        // Reload page or redirect
        window.location.href = window.location.pathname + '?success=1';
        return;
      }

      // Other error
      console.error('[FormData Debug] Unexpected response:', response.status);
      console.log('Response preview:', responseText.substring(0, 200));
      alert('Submission failed. Check console for details.');

    } catch (error) {
      console.error('[FormData Debug] Network error:', error);
      alert('Network error. Check console for details.');
    } finally {
      submitBtn.disabled = false;
      submitBtn.textContent = 'SUBMIT';
    }
  }

  // Form validation before submit
  form.addEventListener('submit', function(e) {
    // Use FormData approach if enabled, otherwise use base64
    if (USE_FORMDATA) {
      submitWithFormData(e);
      return;
    }

    // ORIGINAL BASE64 APPROACH (fallback)
    // Check required fields
    const requiredFields = form.querySelectorAll('[required]');
    let isValid = true;

    requiredFields.forEach(field => {
      if (!field.value.trim()) {
        isValid = false;
        field.style.borderColor = '#dc3545';
        field.addEventListener('input', function() {
          this.style.borderColor = '';
        }, { once: true });
      }
    });

    if (!isValid) {
      e.preventDefault();
      alert('Please fill in all required fields.');
      return false;
    }

    // Update file info before submit (wait for base64 conversion if needed)
    if (selectedFiles.length > 0 && selectedBase64s.length !== selectedFiles.length) {
      e.preventDefault();
      alert('Please wait for all files to finish uploading.');
      return false;
    }
    updateFileInfo();

    // Check total base64 size before submission
    const totalBase64Size = selectedBase64s.reduce((sum, b64) => sum + b64.length, 0);
    console.log(`[Submit Check] Total base64 size: ${formatFileSize(totalBase64Size)}`);

    if (totalBase64Size > maxBase64TotalSize) {
      e.preventDefault();
      alert(`Files are too large (${formatFileSize(totalBase64Size)}). Please remove some files or use smaller images. Maximum allowed: ${formatFileSize(maxBase64TotalSize)}`);
      submitBtn.disabled = false;
      submitBtn.textContent = 'SUBMIT';
      return false;
    }

    // Show loading state
    submitBtn.disabled = true;
    submitBtn.textContent = 'Submitting...';

    // Re-enable button after a delay in case of errors
    setTimeout(() => {
      submitBtn.disabled = false;
      submitBtn.textContent = 'SUBMIT';
    }, 10000);
  });

  // File selection
  fileSelectBtn.addEventListener('click', (e) => {
    console.log('[Debug] Upload button clicked');
    e.preventDefault();
    e.stopPropagation();

    // Fix: Clear value to allow selecting the same file again and reset state
    fileInput.value = '';

    console.log('[Debug] Triggering fileInput.click()');
    fileInput.click();
  });

  fileInput.addEventListener('click', (e) => {
    console.log('[Debug] File input received click event');
    // Note: The file dialog should open now.
    // If it doesn't, the browser might be blocking it or the element is disabled/hidden in a way that prevents it.
    console.log('[Debug] fileInput disabled?', fileInput.disabled);
    console.log('[Debug] fileInput style display?', fileInput.style.display);
  });

  fileUploadArea.addEventListener('click', (e) => {
    if (e.target === fileUploadArea || e.target.closest('.file-upload-text')) {
      fileInput.click();
    }
  });

  fileInput.addEventListener('change', (e) => {
    console.log('[Debug] File input change event fired', e.target.files);
    handleFileSelect(e);
    // Optional: Clear the value so the same file can be selected again if needed,
    // or just so the change event fires if the user selects the same file.
    // this.value = '';
  });

  // Drag and drop
  fileUploadArea.addEventListener('dragenter', handleDragEnter);
  fileUploadArea.addEventListener('dragover', handleDragOver);
  fileUploadArea.addEventListener('dragleave', handleDragLeave);
  fileUploadArea.addEventListener('drop', handleDrop);

  // Paste functionality
  document.addEventListener('paste', handlePaste);

  function handleFileSelect(e) {
    const files = Array.from(e.target.files);
    addFiles(files);
  }

  function handleDragEnter(e) {
    e.preventDefault();
    dragCounter++;
    fileUploadArea.classList.add('dragover');
    fileUploadArea.style.backgroundColor = '#e8f4fd';
    fileUploadArea.style.borderColor = '#0066cc';
    fileUploadArea.style.transform = 'scale(1.02)';
    fileUploadArea.style.transition = 'all 0.2s ease';
  }

  function handleDragOver(e) {
    e.preventDefault();
    if (!fileUploadArea.classList.contains('dragover')) {
      fileUploadArea.classList.add('dragover');
      fileUploadArea.style.backgroundColor = '#e8f4fd';
      fileUploadArea.style.borderColor = '#0066cc';
      fileUploadArea.style.transform = 'scale(1.02)';
    }
  }

  function handleDragLeave(e) {
    e.preventDefault();
    dragCounter--;

    if (dragCounter === 0) {
      fileUploadArea.classList.remove('dragover');
      fileUploadArea.style.backgroundColor = '';
      fileUploadArea.style.borderColor = '';
      fileUploadArea.style.transform = '';
    }
  }

  function handleDrop(e) {
    e.preventDefault();

    dragCounter = 0;
    fileUploadArea.classList.remove('dragover');
    fileUploadArea.style.backgroundColor = '';
    fileUploadArea.style.borderColor = '';
    fileUploadArea.style.transform = '';

    fileUploadArea.style.backgroundColor = '#d4edda';
    fileUploadArea.style.borderColor = '#28a745';
    setTimeout(() => {
      fileUploadArea.style.backgroundColor = '';
      fileUploadArea.style.borderColor = '';
    }, 500);

    const files = Array.from(e.dataTransfer.files);
    addFiles(files);
  }

  function handlePaste(e) {
    const items = Array.from(e.clipboardData.items);
    const files = items
      .filter(item => item.kind === 'file')
      .map(item => item.getAsFile());
    if (files.length > 0) {
      fileUploadArea.style.backgroundColor = '#fff3cd';
      fileUploadArea.style.borderColor = '#ffc107';
      setTimeout(() => {
        fileUploadArea.style.backgroundColor = '';
        fileUploadArea.style.borderColor = '';
      }, 300);

      addFiles(files);
    }
  }

  function addFiles(files) {
    if (selectedFiles.length + files.length > maxFiles) {
      alert(`You can only upload up to ${maxFiles} files. Images will be compressed to reduce size.`);
      showErrorFeedback();
      return;
    }

    const currentSize = selectedFiles.reduce((sum, file) => sum + file.size, 0);
    const newSize = files.reduce((sum, file) => sum + file.size, 0);

    if (currentSize + newSize > maxTotalSize) {
      alert('Total file size must be less than 50MB. Images will be automatically compressed.');
      showErrorFeedback();
      return;
    }

    files.forEach(file => {
      if (file) {
        if (file.size > maxFileSize) {
          alert(`File "${file.name}" is too large. Max size is 50MB per file. Images will be compressed automatically.`);
          showErrorFeedback();
        } else {
          selectedFiles.push(file);
        }
      }
    });

    updateFileList();
    convertAllFilesToBase64();
  }

  function showErrorFeedback() {
    fileUploadArea.style.backgroundColor = '#f8d7da';
    fileUploadArea.style.borderColor = '#dc3545';
    setTimeout(() => {
      fileUploadArea.style.backgroundColor = '';
      fileUploadArea.style.borderColor = '';
    }, 1000);
  }

  function removeFile(index) {
    selectedFiles.splice(index, 1);
    selectedBase64s.splice(index, 1);
    updateFileList();
    updateFileInfo();
  }

  function updateFileList() {
    fileList.innerHTML = '';
    selectedFiles.forEach((file, index) => {
      const fileItem = document.createElement('div');
      fileItem.className = 'file-item';
      fileItem.innerHTML = `
        <span>${file.name} (${formatFileSize(file.size)})</span>
        <button type="button" class="file-remove" onclick="removeFile(${index})">Remove</button>
      `;
      fileList.appendChild(fileItem);
    });
  }

  function updateFileInfo() {
    // Only base64 strings, comma-separated
    if (selectedBase64s.length > 0) {
      fileInfoData.value = selectedBase64s.join(',');
      console.log('[Base64 Output] fileInfoData.value:', fileInfoData.value);
    } else {
      fileInfoData.value = '';
      console.log('[Base64 Output] fileInfoData.value is empty');
    }
  }

  // Compress image file to reduce size
  function compressImage(file) {
    return new Promise((resolve, reject) => {
      // If it's not an image, return as is
      if (!file.type.startsWith('image/')) {
        console.log(`[Compression] File "${file.name}" is not an image, skipping compression`);
        resolve(file);
        return;
      }

      const reader = new FileReader();
      reader.onload = function(e) {
        const img = new Image();
        img.onload = function() {
          const canvas = document.createElement('canvas');
          let width = img.width;
          let height = img.height;

          // Calculate new dimensions to keep aspect ratio - more aggressive
          const maxDimension = 1200; // Reduced from 1920 to 1200
          if (width > maxDimension || height > maxDimension) {
            if (width > height) {
              height = (height / width) * maxDimension;
              width = maxDimension;
            } else {
              width = (width / height) * maxDimension;
              height = maxDimension;
            }
          }

          canvas.width = width;
          canvas.height = height;

          const ctx = canvas.getContext('2d');
          ctx.drawImage(img, 0, 0, width, height);

          // Try different quality levels to get under target size - start more aggressive
          let quality = 0.65; // Start at 65% instead of 80%
          const tryCompress = (q) => {
            canvas.toBlob((blob) => {
              if (!blob) {
                reject(new Error('Compression failed'));
                return;
              }

              console.log(`[Compression] "${file.name}": ${formatFileSize(file.size)} -> ${formatFileSize(blob.size)} (quality: ${q})`);

              // If still too large and we can reduce quality more, try again
              if (blob.size > maxCompressedSize && q > 0.2) {
                tryCompress(q - 0.1);
              } else {
                // Create a new File object from the blob
                const compressedFile = new File([blob], file.name, {
                  type: 'image/jpeg',
                  lastModified: Date.now(),
                });
                resolve(compressedFile);
              }
            }, 'image/jpeg', q);
          };

          tryCompress(quality);
        };

        img.onerror = function() {
          console.error(`[Compression] Failed to load image "${file.name}"`);
          resolve(file); // Return original if compression fails
        };

        img.src = e.target.result;
      };

      reader.onerror = function() {
        console.error(`[Compression] Failed to read file "${file.name}"`);
        resolve(file); // Return original if reading fails
      };

      reader.readAsDataURL(file);
    });
  }

  async function convertAllFilesToBase64() {
    selectedBase64s = [];
    compressedFiles = []; // Clear compressed files array
    if (selectedFiles.length === 0) {
      updateFileInfo();
      return;
    }

    console.log('[File Processing] Starting file compression...');

    for (let idx = 0; idx < selectedFiles.length; idx++) {
      const file = selectedFiles[idx];

      try {
        // Compress the file first (if it's an image)
        const compressedFile = await compressImage(file);

        // Store compressed File object for FormData approach
        compressedFiles[idx] = compressedFile;
        console.log(`[File Processing] Compressed: "${file.name}" ${formatFileSize(file.size)} -> ${formatFileSize(compressedFile.size)}`);

        // Also convert to base64 for backward compatibility (if using base64 mode)
        if (!USE_FORMDATA) {
          const base64 = await new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = function(e) {
              let base64 = e.target.result;
              if (base64.indexOf('base64,') !== -1) {
                base64 = base64.split('base64,')[1];
              }
              resolve(base64);
            };
            reader.onerror = () => reject(new Error('Failed to read file'));
            reader.readAsDataURL(compressedFile);
          });

          selectedBase64s[idx] = base64;
          console.log(`[Base64 Debug] File "${file.name}" converted to base64`);
        }

      } catch (error) {
        selectedBase64s[idx] = '';
        compressedFiles[idx] = null;
        console.error(`[File Processing] Error processing file "${file.name}":`, error);
      }
    }

    console.log('[File Processing] All files processed.');
    if (!USE_FORMDATA) {
      updateFileInfo();
    }
  }

  function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
  }

  // Make removeFile function global
  window.removeFile = removeFile;
});
</script>
