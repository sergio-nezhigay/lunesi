{% comment %}
Shopify Contact Form with File Upload and Base64 Encoding
Place this in your contact page template or as a section
{% endcomment %}
{{ 'section-contact-form.css' | asset_url | stylesheet_tag }}
{{ 'custom-form.css' | asset_url | stylesheet_tag }}
{{ 'section-rich-text.css' | asset_url | stylesheet_tag }}
{% schema %}
{
  "name": "Custom Contact Form",
  "settings": [
    {
      "type": "richtext",
      "id": "rich_text",
      "label": "Rich text",
      "default": "<h2>Contact Us</h2><p>Feel free to reach out to us at any time. We're here to help with orders, product questions, and any feedback you may have.<br></p><p>Our customer service team can assist by email Monday through Friday, from 9am to 6pm (excluding holidays). We'll aim to get back to you within 2 business days.</p><p>*indicates a required field</p>"
    },
    {
      "type": "range",
      "id": "padding_top",
      "label": "Section padding top (px)",
      "min": 0,
      "max": 100,
      "step": 4,
      "default": 16
    },
    {
      "type": "range",
      "id": "padding_bottom",
      "label": "Section padding bottom (px)",
      "min": 0,
      "max": 100,
      "step": 4,
      "default": 16
    }
  ],
  "presets": [
    {
      "name": "Custom Contact Form"
    }
  ]
}
{% endschema %}

<div class="contact-form-wrapper page-width" style="padding-top: {{ section.settings.padding_top | default: 16 }}px; padding-bottom: {{ section.settings.padding_bottom | default: 16 }}px;">
  <div class="rich-text">
      <div class="rich-text__blocks left mobile-left">
        <use-animate animate="">
          <div class="rich-text__text typeset2 rte">
            {{ section.settings.rich_text }}
          </div>
        </use-animate>
      </div>
  </div>
  {% form 'contact', id: 'contact-form', class: 'contact-form' %}
    {% if form.errors %}
      <div class="error-message">
        {{ form.errors | default_errors }}
      </div>
    {% endif %}
    {% if form.posted_successfully? %}
      <div class="success-message">
        <p>Thank you for contacting us! We'll get back to you soon.</p>
      </div>
    {% endif %}
    
    <div class="form-group">
      <input 
        type="text" 
        id="contact-name" 
        name="contact[name]" 
        class="form-input" 
        value="{{ form.name }}" 
        required 
        placeholder="First and Last Name*"
      >
    </div>

    <div class="form-group">
      <input 
        type="email" 
        id="contact-email" 
        name="contact[email]" 
        class="form-input" 
        value="{{ form.email }}" 
        required 
        placeholder="Email*"
      >
    </div>

    <div class="form-group">
      <select id="contact-reason" name="contact[reason]" class="form-select" required>
        <option value="">Contact Reason*</option>
        <option value="Order status" {% if form.reason == 'Order status' %}selected{% endif %}>Order status</option>
        <option value="Cancel or modify an order" {% if form.reason == 'Cancel or modify an order' %}selected{% endif %}>Cancel or modify an order</option>
        <option value="My order is missing" {% if form.reason == 'My order is missing' %}selected{% endif %}>My order is missing</option>
        <option value="My order arrived damaged" {% if form.reason == 'My order arrived damaged' %}selected{% endif %}>My order arrived damaged</option>
        <option value="Issue with my product" {% if form.reason == 'Issue with my product' %}selected{% endif %}>Issue with my product</option>
        <option value="Shipping questions" {% if form.reason == 'Shipping questions' %}selected{% endif %}>Shipping questions</option>
        <option value="Product questions" {% if form.reason == 'Product questions' %}selected{% endif %}>Product questions</option>
        <option value="Partnerships / collaboration" {% if form.reason == 'Partnerships / collaboration' %}selected{% endif %}>Partnerships / collaboration</option>
        <option value="Other / general inquiry" {% if form.reason == 'Other / general inquiry' %}selected{% endif %}>Other / general inquiry</option>
      </select>
      <span class="form-select-arrow">
        <svg width="18" height="18" viewBox="0 0 20 20" fill="none" style="display:block;" xmlns="http://www.w3.org/2000/svg">
          <path d="M6 8L10 12L14 8" stroke="#757575" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </span>
    </div>

    <!-- Conditional Order Number Field -->
    <div class="form-group" id="order-number-group" style="display: none;">
      <input 
        type="text" 
        id="contact-order-number" 
        name="contact[order_number]" 
        class="form-input" 
        value="{{ form.order_number }}" 
        placeholder="Order Number*"
      >
      <div id="cancel-modify-notice" class="order-notice" style="display: none;">
        We'll make every effort to accommodate your request during business hours, but please note that once an order is placed, we cannot guarantee any changes can be made.
      </div>
    </div>

    <!-- Conditional Items with Issues Field -->
    <div class="form-group" id="items-issues-group" style="display: none;">
      <input 
        type="text" 
        id="contact-items-issues" 
        name="contact[items_issues]" 
        class="form-input" 
        value="{{ form.items_issues }}" 
        placeholder="Item(s) with issues"
      >
    </div>

    <div class="form-group">
      <input 
        type="text" 
        id="contact-topic" 
        name="contact[topic]" 
        class="form-input" 
        value="{{ form.topic }}" 
        required 
        placeholder="Topic*"
      >
    </div>

    <div class="form-group">
      <textarea 
        id="contact-body" 
        name="contact[body]" 
        class="form-textarea" 
        required 
        placeholder="Tell us the details.*"
      >{{ form.body }}</textarea>
    </div>

    <div class="form-group file-upload-group">
      <div class="file-size-info">
        (Optional: 10 files max, total file size must be less than 50MB)
      </div>
      <div class="file-upload-area" id="file-upload-area">
        <div class="file-upload-text">
          <div class="file-upload-icon">
            <svg xmlns="http://www.w3.org/2000/svg" x="0px" y="0px" width="50" height="50" viewBox="0 0 50 50">
              <path d="M 7 2 L 7 48 L 43 48 L 43 15.414063 L 29.410156 2 Z M 9 4 L 28 4 L 28 17 L 41 17 L 41 46 L 9 46 Z M 30 5.390625 L 39.734375 15 L 30 15 Z M 33.5 21.332031 C 32.457031 21.335938 31.609375 22.15625 31.609375 23.167969 C 31.613281 24.179688 32.457031 25 33.5 25 C 34.542969 25 35.386719 24.179688 35.390625 23.167969 C 35.390625 22.15625 34.542969 21.335938 33.5 21.332031 Z M 21.167969 24 C 20.835938 23.988281 20.519531 24.136719 20.324219 24.40625 L 12.863281 34.488281 C 12.640625 34.792969 12.605469 35.195313 12.773438 35.53125 C 12.945313 35.871094 13.289063 36.082031 13.667969 36.082031 L 28.425781 36.082031 C 28.449219 36.082031 28.472656 36.082031 28.496094 36.082031 C 28.5 36.082031 28.5 36.082031 28.503906 36.082031 L 35.015625 36 C 35.398438 35.996094 35.742188 35.769531 35.90625 35.421875 C 36.066406 35.074219 36.015625 34.667969 35.777344 34.371094 L 29.269531 26.386719 C 29.078125 26.148438 28.785156 26.011719 28.480469 26.015625 C 28.164063 26.023438 27.871094 26.175781 27.6875 26.429688 L 25.554688 29.363281 L 21.9375 24.410156 C 21.753906 24.164063 21.472656 24.011719 21.167969 24 Z M 21.125 26.6875 L 24.753906 31.660156 C 24.757813 31.667969 24.761719 31.671875 24.765625 31.675781 L 26.523438 34.082031 L 15.652344 34.082031 Z M 28.539063 28.65625 L 32.917969 34.027344 L 29 34.078125 L 26.796875 31.0625 Z"></path>
            </svg>
          </div>
          <span>Drag or paste image here</span>
        </div>
        <a class="file-upload-button" id="file-select-btn">
          <div class="file-upload-icon"> 
            <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGAAAABgCAYAAADimHc4AAAACXBIWXMAAAsTAAALEwEAmpwYAAADHElEQVR4nO2cz05UMRSHP10wIkRYmKgvI74IwisggWfQlUQxsNIXUDAuDEs3ok/gn5WudCVoAGdZ09iJzci9c+9lpqfQ35eczfy5bc932pk7aQeEEEIIIYQQQgghhMibHvAA+A58A+6Hx0QCpoBXgBuKPeCKDNgk30mCffKdJNgn30mCffKdJNgn30mCffKdJNgn30mCffKdJDSnB7wekci655u8V3fMZ6j8vXC3W/V8m2uIDpU/qN6q13S5lgAet0xYnYCmEjaU+b9cBk5aVusoAU0kHAGXht5TrIB+y6WiiYBREvqhbQE8a7lONxVQJ+GpMv+P2SChH5aGhyM+JNsIIFxrI1y7H5Lv2xRDNF2T2wqIr691fwy4jgLEmHASYIuTgP+ZB5aBXeATcHxKkg6BTWA6QwFXgSfAz1OuexzGtAMshbFmg/9dZT0k1zWM7QwFbLfo/wGwlsPPGbeA9y06PoiTM94EuTEL8H353WEc74CbGCb/a4dOXyQBLuQguYRex8ofxNY5X4LcUOynXo7WO3bUr52PMv0Qng6/yrb5LItjlUTMj+jkc2ABmJlgH9wEBNQxE8a0U9P2D2COBCzXdGIlRQdILyBmtab9uyk6sFvR+AvS4QwFmOfgc0XjtylHwEJF+/5mbeIcVTQ+W5CA2Yr2fW4u/OApvQ9FDz5CApCA8qovQjMACSiv+iI0A5CA8qovQjMACSiv+iI0A5CA8qovQjMACSiv+iI0A5CA8qovQjMACSiv+iI0A5CA8qovQjMACSiv+iI0A5CA8qovougZcFix6y4lRQvYPKV9v+UxJUULmA6baU9CbI1hv2lbihaQw6lHCTBGAoyRAGMkoFQBOWzOteZaRQ5+WW5P91u2S+GO5fb0qmM6/vFSeFlzPGviLOVwUM2QtZrxL6Y6pHdQ04ndMEUneUgvNTNhTFWVn/SQ3qgqKDVWSEgvHNO3HrTLJN6G/yxNij+e/yWDwTvj8Dm4gRHXgTcZJMEZxb7ln3UMmArffn5kkBCXKPxY71ksO3XMhZPi/rDyx5o75vMYR8CHMLbFlN92hBBCCCGEEEIIIQQXhj937+tQmPExPQAAAABJRU5ErkJggg==" alt="upload--v1">
          </div> 
          <span>Upload</span>
        </a>
        <input type="file" id="file-input" multiple accept="image/*,.pdf,.doc,.docx" style="display: none;">
      </div>
      <div class="file-list" id="file-list"></div>
    </div>

   <!-- Hidden field to store file information as text -->
    <input type="hidden" name="contact[file_info]" id="file-info-data">

    <button type="submit" class="submit-button" id="submit-btn">
      SUBMIT
    </button>
  {% endform %}
</div>

<script>
{% comment %} 
Rewritten to:
- Convert files to base64 and store only base64 strings (no JSON, no file info) in the hidden field.
- Only base64 data (comma-separated if multiple).
- No JSON output in the hidden field.
- Add console debugging for base64 conversion.
{% endcomment %}
document.addEventListener('DOMContentLoaded', function() {
  const fileInput = document.getElementById('file-input');
  const fileUploadArea = document.getElementById('file-upload-area');
  const fileSelectBtn = document.getElementById('file-select-btn');
  const fileList = document.getElementById('file-list');
  const fileInfoData = document.getElementById('file-info-data');
  const submitBtn = document.getElementById('submit-btn');
  const contactReason = document.getElementById('contact-reason');
  const orderNumberGroup = document.getElementById('order-number-group');
  const orderNumberInput = document.getElementById('contact-order-number');
  const cancelModifyNotice = document.getElementById('cancel-modify-notice');
  const itemsIssuesGroup = document.getElementById('items-issues-group');
  const itemsIssuesInput = document.getElementById('contact-items-issues');
  const form = document.getElementById('contact-form');
  
  let selectedFiles = [];
  let selectedBase64s = [];
  const maxFiles = 10; // Reduced for base64
  const maxTotalSize = 50 * 1024 * 1024; // 2MB max for base64 encoding
  const maxFileSize = 500 * 1024; // 500KB per file max
  let dragCounter = 0;

  // Order-related reasons that should show the order number field
  const orderRelatedReasons = [
    'Order status',
    'Cancel or modify an order',
    'My order is missing',
    'My order arrived damaged',
    'Issue with my product',
    'Shipping questions',
    'Other / general inquiry'
  ];

  // Handle contact reason change
  contactReason.addEventListener('change', function() {
    const selectedReason = this.value;
    
    if (orderRelatedReasons.includes(selectedReason)) {
      orderNumberGroup.style.display = 'block';
      orderNumberInput.required = true;
      
      if (selectedReason === 'Cancel or modify an order') {
        cancelModifyNotice.style.display = 'block';
      } else {
        cancelModifyNotice.style.display = 'none';
      }

      if (selectedReason === 'Issue with my product') {
        itemsIssuesGroup.style.display = 'block';
        itemsIssuesInput.required = true;
      } else {
        itemsIssuesGroup.style.display = 'none';
        itemsIssuesInput.required = false;
        itemsIssuesInput.value = '';
      }
    } else {
      orderNumberGroup.style.display = 'none';
      orderNumberInput.required = false;
      orderNumberInput.value = '';
      cancelModifyNotice.style.display = 'none';
      itemsIssuesGroup.style.display = 'none';
      itemsIssuesInput.required = false;
      itemsIssuesInput.value = '';
    }
  });

  // Check initial state on page load
  if (orderRelatedReasons.includes(contactReason.value)) {
    orderNumberGroup.style.display = 'block';
    orderNumberInput.required = true;
    
    if (contactReason.value === 'Cancel or modify an order') {
      cancelModifyNotice.style.display = 'block';
    }

    if (contactReason.value === 'Issue with my product') {
      itemsIssuesGroup.style.display = 'block';
      itemsIssuesInput.required = true;
    }
  }

  // Form validation before submit
  form.addEventListener('submit', function(e) {
    // Check required fields
    const requiredFields = form.querySelectorAll('[required]');
    let isValid = true;
    
    requiredFields.forEach(field => {
      if (!field.value.trim()) {
        isValid = false;
        field.style.borderColor = '#dc3545';
        field.addEventListener('input', function() {
          this.style.borderColor = '';
        }, { once: true });
      }
    });

    if (!isValid) {
      e.preventDefault();
      alert('Please fill in all required fields.');
      return false;
    }

    // Update file info before submit (wait for base64 conversion if needed)
    if (selectedFiles.length > 0 && selectedBase64s.length !== selectedFiles.length) {
      e.preventDefault();
      alert('Please wait for all files to finish uploading.');
      return false;
    }
    updateFileInfo();

    // Show loading state
    submitBtn.disabled = true;
    submitBtn.textContent = 'Submitting...';
    
    // Re-enable button after a delay in case of errors
    setTimeout(() => {
      submitBtn.disabled = false;
      submitBtn.textContent = 'SUBMIT';
    }, 5000);
  });

  // File selection
  fileSelectBtn.addEventListener('click', (e) => {
    e.preventDefault();
    e.stopPropagation();
    fileInput.click();
  });
  
  fileUploadArea.addEventListener('click', (e) => {
    if (e.target === fileUploadArea || e.target.closest('.file-upload-text')) {
      fileInput.click();
    }
  });
  
  fileInput.addEventListener('change', handleFileSelect);

  // Drag and drop
  fileUploadArea.addEventListener('dragenter', handleDragEnter);
  fileUploadArea.addEventListener('dragover', handleDragOver);
  fileUploadArea.addEventListener('dragleave', handleDragLeave);
  fileUploadArea.addEventListener('drop', handleDrop);

  // Paste functionality
  document.addEventListener('paste', handlePaste);

  function handleFileSelect(e) {
    const files = Array.from(e.target.files);
    addFiles(files);
  }

  function handleDragEnter(e) {
    e.preventDefault();
    dragCounter++;
    fileUploadArea.classList.add('dragover');
    fileUploadArea.style.backgroundColor = '#e8f4fd';
    fileUploadArea.style.borderColor = '#0066cc';
    fileUploadArea.style.transform = 'scale(1.02)';
    fileUploadArea.style.transition = 'all 0.2s ease';
  }

  function handleDragOver(e) {
    e.preventDefault();
    if (!fileUploadArea.classList.contains('dragover')) {
      fileUploadArea.classList.add('dragover');
      fileUploadArea.style.backgroundColor = '#e8f4fd';
      fileUploadArea.style.borderColor = '#0066cc';
      fileUploadArea.style.transform = 'scale(1.02)';
    }
  }

  function handleDragLeave(e) {
    e.preventDefault();
    dragCounter--;
    
    if (dragCounter === 0) {
      fileUploadArea.classList.remove('dragover');
      fileUploadArea.style.backgroundColor = '';
      fileUploadArea.style.borderColor = '';
      fileUploadArea.style.transform = '';
    }
  }

  function handleDrop(e) {
    e.preventDefault();
    
    dragCounter = 0;
    fileUploadArea.classList.remove('dragover');
    fileUploadArea.style.backgroundColor = '';
    fileUploadArea.style.borderColor = '';
    fileUploadArea.style.transform = '';
    
    fileUploadArea.style.backgroundColor = '#d4edda';
    fileUploadArea.style.borderColor = '#28a745';
    setTimeout(() => {
      fileUploadArea.style.backgroundColor = '';
      fileUploadArea.style.borderColor = '';
    }, 500);
    
    const files = Array.from(e.dataTransfer.files);
    addFiles(files);
  }

  function handlePaste(e) {
    const items = Array.from(e.clipboardData.items);
    const files = items
      .filter(item => item.kind === 'file')
      .map(item => item.getAsFile());
    if (files.length > 0) {
      fileUploadArea.style.backgroundColor = '#fff3cd';
      fileUploadArea.style.borderColor = '#ffc107';
      setTimeout(() => {
        fileUploadArea.style.backgroundColor = '';
        fileUploadArea.style.borderColor = '';
      }, 300);
      
      addFiles(files);
    }
  }

  function addFiles(files) {
    if (selectedFiles.length + files.length > maxFiles) {
      alert(`You can only upload up to ${maxFiles} files.`);
      showErrorFeedback();
      return;
    }

    const currentSize = selectedFiles.reduce((sum, file) => sum + file.size, 0);
    const newSize = files.reduce((sum, file) => sum + file.size, 0);
    
    if (currentSize + newSize > maxTotalSize) {
      alert('Total file size must be less than 50MB.');
      showErrorFeedback();
      return;
    }

    files.forEach(file => {
      if (file) {
        if (file.size > maxFileSize) {
          alert(`File "${file.name}" is too large. Max size is ${Math.round(maxFileSize/1024)}KB.`);
          showErrorFeedback();
        } else {
          selectedFiles.push(file);
        }
      }
    });

    updateFileList();
    convertAllFilesToBase64();
  }

  function showErrorFeedback() {
    fileUploadArea.style.backgroundColor = '#f8d7da';
    fileUploadArea.style.borderColor = '#dc3545';
    setTimeout(() => {
      fileUploadArea.style.backgroundColor = '';
      fileUploadArea.style.borderColor = '';
    }, 1000);
  }

  function removeFile(index) {
    selectedFiles.splice(index, 1);
    selectedBase64s.splice(index, 1);
    updateFileList();
    updateFileInfo();
  }

  function updateFileList() {
    fileList.innerHTML = '';
    selectedFiles.forEach((file, index) => {
      const fileItem = document.createElement('div');
      fileItem.className = 'file-item';
      fileItem.innerHTML = `
        <span>${file.name} (${formatFileSize(file.size)})</span>
        <button type="button" class="file-remove" onclick="removeFile(${index})">Remove</button>
      `;
      fileList.appendChild(fileItem);
    });
  }

  function updateFileInfo() {
    // Only base64 strings, comma-separated
    if (selectedBase64s.length > 0) {
      fileInfoData.value = selectedBase64s.join(',');
      console.log('[Base64 Output] fileInfoData.value:', fileInfoData.value);
    } else {
      fileInfoData.value = '';
      console.log('[Base64 Output] fileInfoData.value is empty');
    }
  }

  function convertAllFilesToBase64() {
    selectedBase64s = [];
    if (selectedFiles.length === 0) {
      updateFileInfo();
      return;
    }
    let filesProcessed = 0;
    selectedFiles.forEach((file, idx) => {
      const reader = new FileReader();
      reader.onload = function(e) {
        let base64 = e.target.result;
        if (base64.indexOf('base64,') !== -1) {
          base64 = base64.split('base64,')[1];
        }
        selectedBase64s[idx] = base64;
        console.log(`[Base64 Debug] File "${file.name}" converted to base64:`, base64.substring(0, 60) + '...');
        filesProcessed++;
        if (filesProcessed === selectedFiles.length) {
          console.log('[Base64 Debug] All files converted. Updating fileInfoData.');
          updateFileInfo();
        }
      };
      reader.onerror = function() {
        selectedBase64s[idx] = '';
        console.error(`[Base64 Debug] Error converting file "${file.name}" to base64.`);
        filesProcessed++;
        if (filesProcessed === selectedFiles.length) {
          updateFileInfo();
        }
      };
      console.log(`[Base64 Debug] Starting conversion for file "${file.name}"`);
      reader.readAsDataURL(file);
    });
  }

  function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
  }

  // Make removeFile function global
  window.removeFile = removeFile;
});
</script>