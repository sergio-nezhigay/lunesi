{%- liquid
  assign cart_total_cents = cart.total_price

  # Parse EU threshold from global settings (format: "EUR:150,SEK:1750")
  assign eu_threshold_setting = settings.cart_tax_eu_threshold | remove: ' ' | split: ','
  assign current_currency = cart.currency.iso_code | upcase
  assign eu_threshold_amount = 0

  # Default fallback (if simple number is provided or as safety)
  assign default_eu_threshold = 150

  assign found_currency_match = false

  for entry in eu_threshold_setting
    if entry contains ':'
      assign parts = entry | split: ':'
      assign currency_code = parts | first | upcase
      assign amount = parts | last | plus: 0

      if currency_code == current_currency
        assign eu_threshold_amount = amount
        assign found_currency_match = true
        break
      endif

      # Capture EUR as a specific fallback if current currency not found
      if currency_code == 'EUR'
        assign default_eu_threshold = amount
      endif
    else
      # Allow simple number as fallback/default
       assign amount = entry | plus: 0
       if amount > 0
         assign default_eu_threshold = amount
       endif
    endif
  endfor

  if found_currency_match == false
    assign eu_threshold_amount = default_eu_threshold
  endif

  assign eu_threshold_cents = eu_threshold_amount | times: 100
  assign non_eu_threshold_cents = settings.cart_tax_non_eu_threshold | times: 100

  assign eu_countries = 'AT,BE,BG,CY,CZ,DE,DK,EE,ES,FI,FR,GR,HR,HU,IE,IT,LT,LU,LV,MT,NL,PL,PT,RO,SE,SI,SK' | split: ','

  assign current_country_code = localization.country.iso_code | upcase
  if cart.attributes.shipping_country != blank
    assign current_country_code = cart.attributes.shipping_country | upcase
  endif

  assign is_eu_country = false
  if eu_countries contains current_country_code
    assign is_eu_country = true
  endif

  assign is_gb = false
  if current_country_code == 'GB'
    assign is_gb = true
  endif

  assign show_custom_tax_message = false

  if is_eu_country == false and is_gb == false and cart_total_cents >= non_eu_threshold_cents
    assign show_custom_tax_message = true
  endif
-%}

<!-- TAX NOTE DEBUG START -->
<!-- Country: {{ current_country_code }} -->
<!-- Is GB: {{ is_gb }} -->
<!-- Is EU: {{ is_eu_country }} -->
<!-- Cart Total (cents): {{ cart_total_cents }} -->
<!-- Cart Total (EUR): {{ cart_total_cents | divided_by: 100.0 }} -->
<!-- Non-EU Threshold (cents): {{ non_eu_threshold_cents }} -->
<!-- Non-EU Threshold (EUR): {{ settings.cart_tax_non_eu_threshold }} -->
<!-- Show Custom Message: {{ show_custom_tax_message }} -->
<!-- TAX NOTE DEBUG END -->

<small class="tax-note caption-large rte">
  {%- if is_gb -%}
    {%- if settings.cart_tax_gb_message != blank -%}
      {{ settings.cart_tax_gb_message }}
    {%- else -%}
      Tax included. Shipping calculated at checkout.
    {%- endif -%}
  {%- elsif is_eu_country -%}
    {%- if cart_total_cents <= eu_threshold_cents -%}
      {%- if settings.cart_tax_eu_below_threshold_message != blank -%}
        {{ settings.cart_tax_eu_below_threshold_message }}
      {%- else -%}
        Tax included. International duties may apply. Shipping calculated at checkout.
      {%- endif -%}
    {%- else -%}
      {%- if settings.cart_tax_eu_above_threshold_message != blank -%}
        {{ settings.cart_tax_eu_above_threshold_message }}
      {%- else -%}
        Tax excluded. International duties may apply. Shipping calculated at checkout.
      {%- endif -%}
    {%- endif -%}
  {%- else -%}
    {%- if show_custom_tax_message -%}
      {%- if settings.cart_tax_custom_message != blank -%}
        {{ settings.cart_tax_custom_message }}
      {%- else -%}
        {{ 'sections.cart.custom_tax_message_default' | t }}
      {%- endif -%}
    {%- else -%}
      {%- if settings.cart_tax_default_message != blank -%}
        {{ settings.cart_tax_default_message }}
      {%- elsif settings.tax_note != blank -%}
         {{ settings.tax_note }}
      {%- elsif cart.taxes_included and shop.shipping_policy.body != blank -%}
        {{ 'sections.cart.taxes_included_and_shipping_policy_html' | t: link: shop.shipping_policy.url }}
      {%- elsif cart.taxes_included -%}
        {{ 'sections.cart.taxes_included_but_shipping_at_checkout' | t }}
      {%- elsif shop.shipping_policy.body != blank -%}
        {{ 'sections.cart.taxes_and_shipping_policy_at_checkout_html' | t: link: shop.shipping_policy.url }}
      {%- else -%}
        {{ 'sections.cart.taxes_and_shipping_at_checkout' | t }}
      {%- endif -%}
    {%- endif -%}
  {%- endif -%}
</small>
